{% extends "base.html" %}

{% block title %}Maritime Dashboard | BergNavn{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .maritime-map {
        height: 500px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .vessel-marker {
        background: #ff6b6b;
        border: 3px solid white;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="text-gradient">üåä Maritime Dashboard</h1>
            <p class="lead">Real-time maritime intelligence with verified data</p>
        </div>
    </div>

    <!-- Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert" id="statusAlert">
                <strong>Status:</strong> <span id="statusText">Loading verified data from APIs...</span>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="row">
        <!-- Weather Data -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üå§Ô∏è Weather Data</h5>
                    <small class="opacity-75">MET Norway + OpenWeather</small>
                </div>
                <div class="card-body">
                    <div id="weatherData">
                        <div class="text-center">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Loading verified weather data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ships Data -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üö¢ Ships Tracking</h5>
                    <small class="opacity-75">Live AIS Data</small>
                </div>
                <div class="card-body">
                    <div id="shipsData">
                        <div class="text-center">
                            <div class="spinner-border text-success"></div>
                            <p class="mt-2">Loading real AIS data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fuel Analytics -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">‚õΩ Fuel Analytics</h5>
                    <small class="opacity-75">AI Optimization</small>
                </div>
                <div class="card-body">
                    <div id="fuelData">
                        <div class="text-center">
                            <div class="spinner-border text-warning"></div>
                            <p class="mt-2">Loading fuel optimization...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Alerts -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">‚ö†Ô∏è System Alerts</h5>
                    <small class="opacity-75">Real-time Monitoring</small>
                </div>
                <div class="card-body">
                    <div id="alertsData">
                        <div class="text-center">
                            <div class="spinner-border text-danger"></div>
                            <p class="mt-2">Loading system status...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Maritime Map -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card maritime-card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üó∫Ô∏è Live Maritime Map</h5>
                    <small class="opacity-75">Real-time vessel positions</small>
                </div>
                <div class="card-body p-0">
                    <div id="maritimeMap" class="maritime-map">
                        <!-- Map will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced ETA Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card maritime-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">‚è±Ô∏è Enhanced ETA Calculation</h5>
                    <small class="opacity-75">Weather-adjusted arrival times</small>
                </div>
                <div class="card-body">
                    <div id="etaData">
                        <div class="text-center">
                            <div class="spinner-border text-info"></div>
                            <p class="mt-2">Calculating ETA with real weather factors...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
// Initialize maritime map
let maritimeMap;
let vesselMarkers = [];

function initializeMaritimeMap() {
    // Center map on Norwegian coast
    maritimeMap = L.map('maritimeMap').setView([62.0, 8.0], 6);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(maritimeMap);
    
    console.log("Maritime map initialized successfully");
}

// Load all real data from existing APIs
async function loadRealData() {
    try {
        updateStatus('Loading verified data from production APIs...', 'info');

        // Initialize map first
        if (!maritimeMap) {
            initializeMaritimeMap();
        }

        // Load all data in parallel with timeout protection
        const timeout = 10000;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        const [weatherResponse, shipsResponse, fuelResponse, alertsResponse, etaResponse] = await Promise.all([
            fetch('/maritime/api/weather-pro', { signal: controller.signal }),
            fetch('/maritime/api/ships-live', { signal: controller.signal }), 
            fetch('/maritime/api/analytics/fuel-optimization', { signal: controller.signal }),
            fetch('/maritime/api/alerts', { signal: controller.signal }),
            fetch('/maritime/api/route/eta-enhanced', { signal: controller.signal })
        ]);

        clearTimeout(timeoutId);

        // Process weather data
        if (weatherResponse.ok) {
            const weatherData = await weatherResponse.json();
            displayWeatherData(weatherData);
        } else {
            displayWeatherError();
        }

        // Process ships data - THIS UPDATES THE MAP
        if (shipsResponse.ok) {
            const shipsData = await shipsResponse.json();
            displayShipsData(shipsData);
            updateMapWithShips(shipsData); // ADDED: Update map with ship positions
        } else {
            displayShipsError();
        }

        // Process fuel data
        if (fuelResponse.ok) {
            const fuelData = await fuelResponse.json();
            displayFuelData(fuelData);
        } else {
            displayFuelError();
        }

        // Process alerts
        if (alertsResponse.ok) {
            const alertsData = await alertsResponse.json();
            displayAlertsData(alertsData);
        } else {
            displayAlertsError();
        }

        // Process ETA
        if (etaResponse.ok) {
            const etaData = await etaResponse.json();
            displayETAData(etaData);
        } else {
            displayETAError();
        }

        updateStatus('All verified data loaded successfully', 'success');

    } catch (error) {
        console.error('Error loading verified data:', error);
        if (error.name === 'AbortError') {
            updateStatus('API timeout - some services may be slow', 'warning');
        } else {
            updateStatus('Error loading data from APIs', 'danger');
        }
    }
}

// NEW FUNCTION: Update map with ship positions
function updateMapWithShips(shipsData) {
    if (!maritimeMap) return;
    
    // Clear existing markers
    vesselMarkers.forEach(marker => maritimeMap.removeLayer(marker));
    vesselMarkers = [];
    
    // Add new markers for each ship
    if (shipsData.ships && shipsData.ships.length > 0) {
        shipsData.ships.forEach(ship => {
            const vesselIcon = L.divIcon({
                className: 'vessel-marker',
                html: '<div style="background: #ff6b6b; border: 3px solid white; border-radius: 50%; width: 12px; height: 12px;"></div>',
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            const marker = L.marker([ship.lat, ship.lon], { icon: vesselIcon })
                .addTo(maritimeMap)
                .bindPopup(`
                    <div class="text-center">
                        <h6><strong>${ship.name}</strong></h6>
                        <small>Type: ${ship.type}</small><br>
                        <small>Speed: ${ship.sog} knots</small><br>
                        <small>Destination: ${ship.destination}</small>
                    </div>
                `);
            
            vesselMarkers.push(marker);
        });
        
        // Fit map to show all vessels
        const group = new L.featureGroup(vesselMarkers);
        maritimeMap.fitBounds(group.getBounds().pad(0.1));
        
        console.log(`Updated map with ${vesselMarkers.length} vessels`);
    }
}

// Display real weather data from MET Norway
function displayWeatherData(data) {
    const container = document.getElementById('weatherData');
    
    if (data.status === 'success' && data.data) {
        const weather = data.data;
        container.innerHTML = `
            <div class="text-center">
                <h3 class="text-primary">${Math.round(weather.temperature)}¬∞C</h3>
                <p><strong>${weather.condition || 'Maritime Conditions'}</strong></p>
                <div class="row text-sm mt-3">
                    <div class="col-6">
                        <small>Wind: ${weather.wind_speed} m/s</small>
                    </div>
                    <div class="col-6">
                        <small>Dir: ${weather.wind_direction}¬∞</small>
                    </div>
                    <div class="col-6">
                        <small>Humidity: ${weather.humidity}%</small>
                    </div>
                    <div class="col-6">
                        <small>Pressure: ${weather.pressure} hPa</small>
                    </div>
                </div>
                <small class="text-muted d-block mt-2">Source: ${data.source || 'Verified API'}</small>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Weather data limited</p>
                <small>${data.message || 'Using fallback data'}</small>
            </div>
        `;
    }
}

// Display real ships data from AIS
function displayShipsData(data) {
    const container = document.getElementById('shipsData');
    
    if ((data.status === 'live' || data.status === 'enhanced_simulation') && data.ships_count !== undefined) {
        container.innerHTML = `
            <div class="text-center">
                <h3 class="text-success">${data.ships_count}</h3>
                <p><strong>Active Vessels</strong></p>
                <div class="row text-sm mt-3">
                    <div class="col-12">
                        <small>Status: ${data.status}</small>
                    </div>
                    <div class="col-12">
                        <small>Source: ${data.data_source || 'AIS'}</small>
                    </div>
                </div>
                ${data.fleet_analytics ? `
                <div class="mt-3 p-2 bg-light rounded">
                    <small class="d-block">Avg Efficiency: ${data.fleet_analytics.average_fuel_efficiency || 'N/A'}/100</small>
                    <small class="d-block">Savings Potential: ${data.fleet_analytics.potential_fuel_savings_percent || 'N/A'}%</small>
                </div>
                ` : ''}
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Ships data limited</p>
                <small>Check AIS connection</small>
            </div>
        `;
    }
}

// Display real fuel analytics
function displayFuelData(data) {
    const container = document.getElementById('fuelData');
    
    if (data.status === 'success' && data.optimization) {
        const optimization = data.optimization;
        container.innerHTML = `
            <div class="text-center">
                <h3 class="text-warning">${optimization.total_potential_savings_percent || '0'}%</h3>
                <p><strong>Fuel Savings Potential</strong></p>
                <div class="row text-sm mt-3">
                    <div class="col-6">
                        <small>Opportunities: ${optimization.opportunities_count || '0'}</small>
                    </div>
                    <div class="col-6">
                        <small>Impact: ${optimization.estimated_impact || 'Medium'}</small>
                    </div>
                </div>
                <small class="text-muted d-block mt-2">AI-powered analysis</small>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Analytics limited</p>
                <small>Processing data...</small>
            </div>
        `;
    }
}

// Display real system alerts
function displayAlertsData(data) {
    const container = document.getElementById('alertsData');
    
    if (data.status === 'success') {
        const alerts = data.alerts || [];
        const alertCount = data.alert_count || alerts.length;
        
        if (alertCount > 0) {
            container.innerHTML = `
                <div class="text-center">
                    <h3 class="text-danger">${alertCount}</h3>
                    <p><strong>Active Alerts</strong></p>
                    ${alerts.slice(0, 3).map(alert => `
                        <div class="alert alert-sm alert-${alert.priority === 'high' ? 'danger' : 'warning'} mb-2 p-2">
                            <small class="d-block">${alert.message || 'System alert'}</small>
                            <small class="text-muted">${alert.timestamp || ''}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="text-center text-success">
                    <h3>‚úì</h3>
                    <p><strong>No Active Alerts</strong></p>
                    <p class="text-sm">All systems operational</p>
                </div>
            `;
        }
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Alerts system</p>
                <small>Status: Monitoring</small>
            </div>
        `;
    }
}

// Display enhanced ETA calculation
function displayETAData(data) {
    const container = document.getElementById('etaData');
    
    if (data.status === 'success' && data.data) {
        const eta = data.data;
        container.innerHTML = `
            <div class="row text-center">
                <div class="col-md-3 mb-3">
                    <h4 class="text-info">${eta.base_eta_hours || 'N/A'}h</h4>
                    <p><small>Base ETA</small></p>
                </div>
                <div class="col-md-3 mb-3">
                    <h4 class="text-primary">${eta.adjusted_eta_hours || 'N/A'}h</h4>
                    <p><small>Adjusted ETA</small></p>
                </div>
                <div class="col-md-3 mb-3">
                    <h4 class="${eta.total_impact_percent > 0 ? 'text-warning' : 'text-success'}">${eta.total_impact_percent || '0'}%</h4>
                    <p><small>Weather Impact</small></p>
                </div>
                <div class="col-md-3 mb-3">
                    <h4 class="text-dark">${Math.round((eta.confidence_score || 0.8) * 100)}%</h4>
                    <p><small>Confidence</small></p>
                </div>
            </div>
            <div class="mt-3 p-3 bg-light rounded">
                <div class="row text-sm">
                    <div class="col-6">
                        <small>Distance: ${eta.distance_nautical_miles || 'N/A'} NM</small>
                    </div>
                    <div class="col-6">
                        <small>Speed: ${eta.average_speed_knots || 'N/A'} knots</small>
                    </div>
                </div>
                <small class="text-muted d-block mt-2">Includes wind/current factors and safety margins</small>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-info">
                <p>ETA calculation in progress</p>
                <small>Processing route data...</small>
            </div>
        `;
    }
}

// Error display functions
function displayWeatherError() {
    document.getElementById('weatherData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è Weather API</p>
            <small>Temporary issue</small>
        </div>
    `;
}

function displayShipsError() {
    document.getElementById('shipsData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è AIS Data</p>
            <small>Connection issue</small>
        </div>
    `;
}

function displayFuelError() {
    document.getElementById('fuelData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è Analytics</p>
            <small>Processing data</small>
        </div>
    `;
}

function displayAlertsError() {
    document.getElementById('alertsData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è Monitoring</p>
            <small>System check</small>
        </div>
    `;
}

function displayETAError() {
    document.getElementById('etaData').innerHTML = `
        <div class="text-center text-info">
            <p>ETA service</p>
            <small>Calculating routes...</small>
        </div>
    `;
}

// Update status display
function updateStatus(message, type) {
    const alert = document.getElementById('statusAlert');
    const text = document.getElementById('statusText');
    
    alert.className = `alert alert-${type}`;
    text.textContent = message;
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map immediately
    initializeMaritimeMap();
    
    // Load data
    loadRealData();
    
    // Refresh data every 30 seconds
    setInterval(loadRealData, 30000);
});
</script>
{% endblock %}