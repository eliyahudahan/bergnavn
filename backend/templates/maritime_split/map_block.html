<div class="card maritime-card shadow-sm">
  <div class="card-header bg-dark text-white">üó∫Ô∏è Live Vessel Map</div>
  <div class="card-body p-0">
    <div id="maritimeMap" style="height:420px;"></div>
  </div>
</div>
<script>
/* Map widget uses global helper fetchSafeJson which is included in dashboard.js */
let _map = null, _markers = [];
function initMap() {
  if (_map) return;
  _map = L.map('maritimeMap').setView([59.0,9.0],7);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(_map);
}
function clearMapMarkers(){ _markers.forEach(m=>_map.removeLayer(m)); _markers=[]; }
function addMarker(s){
  try{
    const lat = parseFloat(s.lat), lon = parseFloat(s.lon);
    if (!isFinite(lat) || !isFinite(lon)) return;
    const icon = L.divIcon({className:'vessel-marker', html:'', iconSize:[14,14]});
    const m = L.marker([lat,lon],{icon}).addTo(_map).bindPopup(`<strong>${s.name}</strong><br>${s.sog} kn`);
    _markers.push(m);
  }catch(e){}
}
(async function(){
  initMap();
  const res = await fetchSafeJson('/maritime/api/ships-live');
  if (res.ok) {
    clearMapMarkers();
    (res.data.ships||[]).forEach(addMarker);
    if (_markers.length){
      const g = new L.featureGroup(_markers);
      _map.fitBounds(g.getBounds().pad(0.15));
    }
  }
})();
</script>
