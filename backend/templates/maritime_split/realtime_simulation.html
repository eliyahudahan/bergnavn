<!-- 
REAL-TIME VESSEL ANALYSIS - Professional Dashboard Integration
BergNavn Maritime Dashboard - Complete Maritime Data Display v5.0

REAL-TIME FIRST: Kystverket â†’ Kystdatahuset â†’ BarentsWatch â†’ Empirical LAST RESORT
Using SAME modules as main dashboard
Data analysis DURING transmission only. Historical data stored below.
-->

{% extends "base.html" %}

{% block title %}Real-Time Vessel Analysis | BergNavn Maritime{% endblock %}

{% block head %}
<!-- Core CSS files - same as dashboard -->
<link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/split/map.css') }}" rel="stylesheet">

<!-- External libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
    /* Analysis-specific styles */
    .analysis-header {
        background: linear-gradient(135deg, #0a2472, #1a237e);
        color: white;
        padding: 20px 0;
        margin-bottom: 30px;
        border-bottom: 3px solid #0066b3;
    }
    
    .transmission-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }
    
    .transmission-active {
        background: #28a745;
        color: white;
    }
    
    .transmission-idle {
        background: #6c757d;
        color: white;
    }
    
    .analysis-panel {
        background: #f8f9fa;
        border-left: 4px solid #17a2b8;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }
    
    .historical-table {
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.85rem;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    
    .historical-table table {
        width: 100%;
        margin-bottom: 0;
    }
    
    .historical-table th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 10;
        border-bottom: 2px solid #dee2e6;
    }
    
    .historical-table td {
        padding: 6px 8px;
    }
    
    .commercial-indicator {
        color: #f1c40f;
        font-weight: bold;
    }
    
    .progress-container {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 10px 0;
    }
    
    .progress-fill {
        height: 100%;
        background: #0066b3;
        border-radius: 4px;
        transition: width 0.3s;
    }
    
    .data-source-badge {
        font-size: 0.6rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 4px;
        font-weight: 600;
    }
    
    .data-source-live {
        background: #28a745;
        color: white;
    }
    
    .data-source-empirical {
        background: #ffc107;
        color: black;
    }
    
    #maritime-map {
        height: 500px;
        width: 100%;
        border-radius: 6px;
        background: #e9f2ff;
        position: relative;
        z-index: 1;
    }
    
    .map-container {
        position: relative;
        height: 500px;
        width: 100%;
        background: #e9f2ff;
        border-radius: 6px;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }
    
    .map-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 6px;
    }
    
    .map-legend {
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        font-size: 0.75rem;
        border: 1px solid #dee2e6;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .legend-color {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hidden data containers - same as dashboard -->
<div id="routes-data" style="display: none;">
    {% if routes %}
        {{ routes|tojson|safe }}
    {% else %}
        []
    {% endif %}
</div>

<div id="waypoints-data" style="display: none;">
    {% if waypoints_data %}
        {{ waypoints_data|tojson|safe }}
    {% else %}
        {}
    {% endif %}
</div>

<!-- Header -->
<div class="analysis-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h3 mb-2">
                    <i class="fas fa-chart-line me-2"></i>
                    Real-Time Vessel Analysis
                </h1>
                <p class="mb-2 opacity-90">Using same REAL-TIME system as main dashboard</p>
                <div class="d-flex align-items-center gap-3 mt-3">
                    <span class="fw-semibold text-success me-3" id="live-status-text">LIVE</span>
                    <span id="local-time-norway" class="local-time-norway">--:--:--</span>
                    <span class="text-white-50" id="norwegian-date">-- --- ----</span>
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="mt-2">
                    <span class="badge bg-primary me-2" id="route-count-badge">0</span>
                    <span class="badge bg-success me-2" id="vessel-count">0</span>
                    <span class="badge bg-info" id="data-source-badge">WAITING</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Container -->
<div class="container">
    <!-- Transmission Status -->
    <div class="alert mb-4" id="transmission-alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-satellite-dish fa-2x me-3" id="transmission-icon"></i>
            <div>
                <strong class="d-block" id="transmission-title">Initializing REAL-TIME vessel tracking...</strong>
                <span id="transmission-message">Using same system as dashboard: Kystverket â†’ Kystdatahuset â†’ BarentsWatch</span>
                <small class="d-block mt-1" id="transmission-source"></small>
            </div>
            <div class="ms-auto">
                <span class="badge" id="transmission-badge">WAITING</span>
            </div>
        </div>
    </div>

    <!-- Map Section - EXACTLY LIKE DASHBOARD -->
    <div class="dashboard-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-geo-alt me-2"></i>
                Norwegian Waters - Live Vessel Tracking
                <small class="text-muted ms-2" id="map-update-time">Updated: --:--</small>
            </h5>
            <div>
                <span class="badge bg-dark me-2" id="vessel-source-badge">WAITING</span>
            </div>
        </div>
        <div class="card-body p-0 position-relative">
            <!-- Map container with same ID as dashboard -->
            <div id="maritime-map"></div>
            
            <!-- Loading overlay -->
            <div id="map-loading-overlay" class="loading-overlay" style="display: none;">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0 text-muted">Loading map data...</p>
                </div>
            </div>
            
            <!-- Data source legend - same as dashboard -->
            <div class="map-legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #28a745;"></span>
                    <span class="legend-label">RTZ Route Start</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #dc3545;"></span>
                    <span class="legend-label">RTZ Route End</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #007bff;"></span>
                    <span class="legend-label">Route Waypoint</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #28a745;"></span>
                    <span class="legend-label">Live Vessel (REAL-TIME)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #ffc107;"></span>
                    <span class="legend-label">Empirical Vessel (FALLBACK)</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Vessel Info -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="stats-card">
                <h6>
                    <i class="bi bi-ship me-2"></i>
                    Vessel Name
                    <span id="vessel-source-indicator" class="data-source-badge">WAITING</span>
                </h6>
                <h2 id="vessel-name" class="fw-bold">--</h2>
                <small class="text-muted" id="vessel-mmsi"></small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h6><i class="bi bi-tag me-2"></i>Vessel Type</h6>
                <h2 id="vessel-type" class="fw-bold">--</h2>
                <small class="text-muted" id="commercial-indicator"></small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h6><i class="bi bi-speedometer2 me-2"></i>Speed</h6>
                <h2 id="vessel-speed" class="fw-bold">--</h2>
                <small class="text-muted" id="vessel-course">Course: --Â°</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <h6><i class="bi bi-geo-alt me-2"></i>Position</h6>
                <h2 id="vessel-position" class="fw-bold">--</h2>
                <small class="text-muted" id="position-accuracy"></small>
            </div>
        </div>
    </div>

    <!-- Live Analysis Panel - ONLY DURING TRANSMISSION -->
    <div id="analysis-panel" style="display: none;">
        <div class="analysis-panel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    Live Analysis - Current Transmission
                </h5>
                <span class="badge live-badge" id="analysis-badge">LIVE</span>
            </div>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="small text-muted">Transmission Duration</div>
                    <div class="h4" id="analysis-duration">0s</div>
                </div>
                <div class="col-md-3">
                    <div class="small text-muted">Data Points Collected</div>
                    <div class="h4" id="analysis-points">0</div>
                </div>
                <div class="col-md-3">
                    <div class="small text-muted">Average Speed</div>
                    <div class="h4" id="analysis-avg-speed">-- kn</div>
                </div>
                <div class="col-md-3">
                    <div class="small text-muted">Est. Fuel Used</div>
                    <div class="h4" id="analysis-fuel">-- t</div>
                </div>
            </div>
            
            <div class="progress-container mt-3">
                <div class="progress-fill" id="analysis-progress" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <!-- Historical Data Storage - ALWAYS VISIBLE -->
    <div class="dashboard-card mt-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-database me-2"></i>
                Historical Vessel Data
            </h5>
            <div>
                <span class="badge bg-secondary me-2" id="stored-vessels">0 vessels</span>
                <span class="badge bg-info" id="stored-points">0 data points</span>
            </div>
        </div>
        <div class="card-body">
            <div class="historical-table">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Vessel</th>
                            <th>Type</th>
                            <th>Duration</th>
                            <th>Source</th>
                            <th>Data Points</th>
                        </tr>
                    </thead>
                    <tbody id="vessels-table-body">
                        <tr>
                            <td colspan="6" class="text-center text-muted">No data stored yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="dashboard-notification" class="dashboard-notification">
    <div class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto" id="notification-title">Notification</strong>
            <small id="notification-time">Now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="notification-message"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- External libraries - same order as dashboard -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Same JavaScript modules as dashboard -->
<script src="{{ url_for('static', filename='js/split/maritime_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/maritime_weather.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/dashboard_controls.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/rtz_waypoints.js') }}"></script>

<!-- Analysis-specific JavaScript -->
<script>
(function() {
    'use strict';
    
    // ============================================
    // HISTORICAL DATA STORAGE
    // ============================================
    window.analysisHistory = {
        vessels: [],
        transmissions: [],
        dataPoints: [],
        currentTransmission: null,
        
        addVessel: function(vessel, source, isRealTime, isCommercial) {
            const vesselId = vessel.mmsi || vessel.name || 'unknown-' + Date.now();
            const existing = this.vessels.find(function(v) { return v.id === vesselId; });
            
            if (!existing) {
                const newVessel = {
                    id: vesselId,
                    name: vessel.name || 'Unknown',
                    type: vessel.type || 'Unknown',
                    mmsi: vessel.mmsi,
                    firstSeen: Date.now(),
                    lastSeen: Date.now(),
                    source: source,
                    isRealTime: isRealTime,
                    isCommercial: isCommercial,
                    dataPoints: 0,
                    transmissions: []
                };
                this.vessels.push(newVessel);
                console.log('âœ… New vessel added to history:', newVessel.name, isRealTime ? 'LIVE' : 'EMPIRICAL');
                return newVessel;
            } else {
                existing.lastSeen = Date.now();
                return existing;
            }
        },
        
        startTransmission: function(vessel, source, isRealTime) {
            const transmission = {
                id: Date.now(),
                vesselName: vessel.name || 'Unknown',
                vesselId: vessel.mmsi || vessel.name,
                vesselType: vessel.type || 'Unknown',
                startTime: Date.now(),
                endTime: null,
                source: source,
                isRealTime: isRealTime,
                dataPoints: [],
                avgSpeed: 0,
                totalDistance: 0,
                duration: null
            };
            
            this.transmissions.push(transmission);
            this.currentTransmission = transmission;
            
            const vesselRecord = this.vessels.find(function(v) { 
                return v.id === (vessel.mmsi || vessel.name); 
            });
            if (vesselRecord) {
                vesselRecord.transmissions.push(transmission.id);
            }
            
            console.log('ðŸ“¡ Transmission started:', vessel.name, source, '# transmissions:', this.transmissions.length);
            this.updateUI();
            return transmission;
        },
        
        addDataPoint: function(point) {
            if (!this.currentTransmission) {
                return;
            }
            
            const dataPoint = {
                mmsi: point.mmsi,
                name: point.name,
                type: point.type,
                speed: point.speed,
                course: point.course,
                lat: point.lat,
                lon: point.lon,
                source: point.source,
                isRealTime: point.isRealTime,
                isCommercial: point.isCommercial,
                timestamp: Date.now(),
                transmissionId: this.currentTransmission.id
            };
            
            this.dataPoints.push(dataPoint);
            this.currentTransmission.dataPoints.push(dataPoint);
            
            const vesselRecord = this.vessels.find(function(v) { 
                return v.id === (point.mmsi || point.name); 
            });
            if (vesselRecord) {
                vesselRecord.dataPoints++;
            }
            
            if (point.speed) {
                var speeds = this.currentTransmission.dataPoints.map(function(p) { return p.speed || 0; });
                var sum = 0;
                for (var i = 0; i < speeds.length; i++) {
                    sum += speeds[i];
                }
                this.currentTransmission.avgSpeed = sum / speeds.length;
            }
            
            console.log('ðŸ“Š Data point added:', this.currentTransmission.dataPoints.length, 'for', point.name);
            this.updateUI();
        },
        
        endTransmission: function() {
            if (this.currentTransmission) {
                this.currentTransmission.endTime = Date.now();
                var duration = (this.currentTransmission.endTime - this.currentTransmission.startTime) / 1000;
                this.currentTransmission.duration = Math.round(duration);
                
                var vesselRecord = this.vessels.find(function(v) { 
                    return v.id === this.currentTransmission.vesselId; 
                }.bind(this));
                if (vesselRecord) {
                    vesselRecord.lastTransmission = this.currentTransmission.endTime;
                }
                
                console.log('ðŸ“¡ Transmission ended:', this.currentTransmission.vesselName, 'duration:', duration + 's', 'points:', this.currentTransmission.dataPoints.length);
                this.currentTransmission = null;
            }
            this.updateUI();
        },
        
        updateUI: function() {
            var vesselsEl = document.getElementById('stored-vessels');
            var pointsEl = document.getElementById('stored-points');
            var tbody = document.getElementById('vessels-table-body');
            
            if (vesselsEl) {
                vesselsEl.textContent = this.vessels.length + ' vessels';
            }
            if (pointsEl) {
                pointsEl.textContent = this.dataPoints.length + ' data points';
            }
            
            if (!tbody) { return; }
            
            if (this.transmissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No data stored yet</td></tr>';
                return;
            }
            
            var start = Math.max(0, this.transmissions.length - 10);
            var html = '';
            for (var i = this.transmissions.length - 1; i >= start; i--) {
                var t = this.transmissions[i];
                var time = new Date(t.startTime).toLocaleTimeString();
                var duration = t.duration ? t.duration + 's' : '--';
                var sourceClass = t.isRealTime ? 'badge bg-success' : 'badge bg-warning';
                var sourceText = t.isRealTime ? 'LIVE' : 'EMP';
                var vessel = null;
                for (var j = 0; j < this.vessels.length; j++) {
                    if (this.vessels[j].id === t.vesselId) {
                        vessel = this.vessels[j];
                        break;
                    }
                }
                var commercialMark = (vessel && vessel.isCommercial) ? 'ðŸ’°' : '';
                
                html += '<tr>' +
                    '<td><small>' + time + '</small></td>' +
                    '<td><small>' + t.vesselName + ' ' + commercialMark + '</small></td>' +
                    '<td><small>' + (vessel ? vessel.type : (t.vesselType || 'Unknown')) + '</small></td>' +
                    '<td><small>' + duration + '</small></td>' +
                    '<td><small><span class="' + sourceClass + '">' + sourceText + '</span></small></td>' +
                    '<td><small>' + t.dataPoints.length + '</small></td>' +
                    '</tr>';
            }
            tbody.innerHTML = html;
        }
    };
    
    console.log('âœ… analysisHistory initialized');
    
    // ============================================
    // ANALYSIS TRACKING
    // ============================================
    var analysisUpdateInterval = null;
    var analysisDataInterval = null;
    var analysisCurrentVessel = null;
    var analysisTransmissionActive = false;
    var analysisLastVesselId = null;
    
    function startAnalysisTracking() {
        console.log('ðŸ“¡ Starting analysis tracking...');
        fetchAnalysisVessel();
        analysisUpdateInterval = setInterval(fetchAnalysisVessel, 30000);
    }
    
    function fetchAnalysisVessel() {
        fetch('/maritime/api/vessels/real-time?city=bergen&radius_km=50')
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.status === 'success' && data.vessels && data.vessels.length > 0) {
                    var vessel = data.vessels[0];
                    var source = data.source || vessel.source;
                    
                    var isRealTime = source && (
                        source.indexOf('REAL-TIME') !== -1 || 
                        source.indexOf('KYSTVERKET') !== -1 ||
                        source.indexOf('KYSTDATAHUSET') !== -1 ||
                        source.indexOf('BARENTS') !== -1
                    );
                    
                    var commercialTypes = ['Cargo', 'Tanker', 'Container', 'Bulk', 'General Cargo', 'Ro-Ro', 'Vehicle', 'LNG', 'Chemical', 'Oil'];
                    var isCommercial = false;
                    if (vessel.type) {
                        var vesselTypeLower = vessel.type.toLowerCase();
                        for (var i = 0; i < commercialTypes.length; i++) {
                            if (vesselTypeLower.indexOf(commercialTypes[i].toLowerCase()) !== -1) {
                                isCommercial = true;
                                break;
                            }
                        }
                    }
                    
                    var vesselId = vessel.mmsi || vessel.name;
                    
                    if (!analysisTransmissionActive || vesselId !== analysisLastVesselId) {
                        if (analysisTransmissionActive) {
                            endAnalysisTransmission();
                        }
                        startAnalysisTransmission(vessel, source, isRealTime, isCommercial);
                        analysisLastVesselId = vesselId;
                    }
                    
                    analysisCurrentVessel = {
                        name: vessel.name,
                        mmsi: vessel.mmsi,
                        type: vessel.type,
                        speed: vessel.speed || 0,
                        course: vessel.course || 0,
                        lat: vessel.latitude || vessel.lat,
                        lon: vessel.longitude || vessel.lon,
                        source: source,
                        isRealTime: isRealTime,
                        isCommercial: isCommercial
                    };
                    
                    document.getElementById('vessel-count').textContent = '1';
                    
                    updateAnalysisVesselInfo(analysisCurrentVessel, source, isRealTime, isCommercial);
                    
                    if (analysisTransmissionActive) {
                        window.analysisHistory.addDataPoint({
                            mmsi: vessel.mmsi,
                            name: vessel.name,
                            type: vessel.type,
                            speed: vessel.speed || 0,
                            course: vessel.course || 0,
                            lat: vessel.latitude || vessel.lat,
                            lon: vessel.longitude || vessel.lon,
                            source: source,
                            isRealTime: isRealTime,
                            isCommercial: isCommercial
                        });
                    }
                    
                    console.log('âœ… Analysis vessel:', vessel.name, 'Real-time:', isRealTime, 'Source:', source);
                    
                } else {
                    if (analysisTransmissionActive) {
                        endAnalysisTransmission();
                        analysisLastVesselId = null;
                    }
                    resetAnalysisDisplay();
                }
            })
            .catch(function(error) {
                console.error('Error fetching analysis vessel:', error);
                if (analysisTransmissionActive) {
                    endAnalysisTransmission();
                    analysisLastVesselId = null;
                }
            });
    }
    
    function startAnalysisTransmission(vessel, source, isRealTime, isCommercial) {
        console.log('ðŸ“¡ NEW ANALYSIS TRANSMISSION:', vessel.name, source);
        analysisTransmissionActive = true;
        window.analysisHistory.addVessel(vessel, source, isRealTime, isCommercial);
        window.analysisHistory.startTransmission(vessel, source, isRealTime);
        
        if (analysisDataInterval) {
            clearInterval(analysisDataInterval);
        }
        analysisDataInterval = setInterval(function() {
            if (analysisTransmissionActive && analysisCurrentVessel) {
                updateAnalysisDisplay();
            }
        }, 5000);
        
        updateUITransmissionActive(source, isRealTime, isCommercial);
    }
    
    function endAnalysisTransmission() {
        console.log('ðŸ“¡ ANALYSIS TRANSMISSION ENDED');
        analysisTransmissionActive = false;
        window.analysisHistory.endTransmission();
        document.getElementById('analysis-panel').style.display = 'none';
        updateUITransmissionIdle();
        
        if (analysisDataInterval) {
            clearInterval(analysisDataInterval);
            analysisDataInterval = null;
        }
    }
    
    function updateAnalysisDisplay() {
        if (!window.analysisHistory.currentTransmission) { return; }
        
        var trans = window.analysisHistory.currentTransmission;
        var duration = Math.floor((Date.now() - trans.startTime) / 1000);
        var dataPoints = trans.dataPoints.length;
        var avgSpeed = trans.avgSpeed ? trans.avgSpeed.toFixed(1) : '0.0';
        
        var fuelRate = 0.25 * (trans.avgSpeed || 10) - 0.8;
        var fuelUsed = fuelRate > 0 ? (fuelRate * duration / 3600).toFixed(2) : '0.00';
        
        document.getElementById('analysis-duration').textContent = duration + 's';
        document.getElementById('analysis-points').textContent = dataPoints;
        document.getElementById('analysis-avg-speed').textContent = avgSpeed + ' kn';
        document.getElementById('analysis-fuel').textContent = fuelUsed + ' t';
        
        var progress = Math.min(100, (duration / 1800) * 100);
        document.getElementById('analysis-progress').style.width = progress + '%';
        document.getElementById('analysis-panel').style.display = 'block';
    }
    
    function updateAnalysisVesselInfo(vessel, source, isRealTime, isCommercial) {
        var elements = {
            name: document.getElementById('vessel-name'),
            mmsi: document.getElementById('vessel-mmsi'),
            type: document.getElementById('vessel-type'),
            speed: document.getElementById('vessel-speed'),
            course: document.getElementById('vessel-course'),
            position: document.getElementById('vessel-position'),
            commercial: document.getElementById('commercial-indicator'),
            sourceIndicator: document.getElementById('vessel-source-indicator'),
            sourceBadge: document.getElementById('vessel-source-badge')
        };
        
        if (elements.name) { elements.name.textContent = vessel.name || 'Unknown'; }
        if (elements.mmsi) { elements.mmsi.innerHTML = vessel.mmsi ? 'MMSI: ' + vessel.mmsi : ''; }
        if (elements.type) { elements.type.textContent = vessel.type || 'Commercial Vessel'; }
        if (elements.speed) { elements.speed.textContent = (vessel.speed || 0).toFixed(1); }
        if (elements.course) { elements.course.textContent = 'Course: ' + (vessel.course || 0) + 'Â°'; }
        
        if (vessel.lat && vessel.lon) {
            if (elements.position) { 
                elements.position.textContent = vessel.lat.toFixed(4) + 'Â°, ' + vessel.lon.toFixed(4) + 'Â°'; 
            }
        } else {
            if (elements.position) { elements.position.textContent = '--'; }
        }
        
        if (elements.commercial) {
            elements.commercial.innerHTML = isCommercial ? 
                '<span class="commercial-indicator">ðŸ’° Commercial Vessel</span>' : 
                '<span class="text-muted">Standard Vessel</span>';
        }
        
        if (elements.sourceIndicator) {
            elements.sourceIndicator.className = 'data-source-badge ' + (isRealTime ? 'data-source-live' : 'data-source-empirical');
            elements.sourceIndicator.textContent = isRealTime ? 'LIVE' : 'EMPIRICAL';
        }
        
        if (elements.sourceBadge) {
            elements.sourceBadge.className = 'badge ' + (isRealTime ? 'bg-success' : 'bg-warning');
            elements.sourceBadge.textContent = isRealTime ? 'LIVE' : 'EMPIRICAL';
        }
    }
    
    function resetAnalysisDisplay() {
        var elements = {
            name: document.getElementById('vessel-name'),
            mmsi: document.getElementById('vessel-mmsi'),
            type: document.getElementById('vessel-type'),
            speed: document.getElementById('vessel-speed'),
            course: document.getElementById('vessel-course'),
            position: document.getElementById('vessel-position'),
            commercial: document.getElementById('commercial-indicator'),
            sourceIndicator: document.getElementById('vessel-source-indicator'),
            sourceBadge: document.getElementById('vessel-source-badge')
        };
        
        if (elements.name) { elements.name.textContent = '--'; }
        if (elements.mmsi) { elements.mmsi.innerHTML = ''; }
        if (elements.type) { elements.type.textContent = '--'; }
        if (elements.speed) { elements.speed.textContent = '--'; }
        if (elements.course) { elements.course.textContent = 'Course: --Â°'; }
        if (elements.position) { elements.position.textContent = '--'; }
        if (elements.commercial) { elements.commercial.innerHTML = ''; }
        if (elements.sourceIndicator) {
            elements.sourceIndicator.className = 'data-source-badge';
            elements.sourceIndicator.textContent = 'WAITING';
        }
        if (elements.sourceBadge) {
            elements.sourceBadge.className = 'badge bg-secondary';
            elements.sourceBadge.textContent = 'WAITING';
        }
        
        document.getElementById('vessel-count').textContent = '0';
    }
    
    function updateUITransmissionActive(source, isRealTime, isCommercial) {
        var alert = document.getElementById('transmission-alert');
        alert.className = 'alert ' + (isRealTime ? 'alert-success' : 'alert-warning') + ' mb-4';
        
        document.getElementById('transmission-icon').className = 'fas ' + (isRealTime ? 'fa-satellite-dish' : 'fa-history') + ' fa-2x me-3';
        document.getElementById('transmission-title').innerHTML = isRealTime ? 'ðŸ”´ LIVE TRANSMISSION' : 'ðŸŸ¡ EMPIRICAL FALLBACK';
        document.getElementById('transmission-message').textContent = 'Tracking ' + (analysisCurrentVessel ? analysisCurrentVessel.name : 'vessel') + ' - ' + (isRealTime ? 'Real-time AIS' : 'Historical simulation');
        document.getElementById('transmission-source').innerHTML = 'Source: <strong>' + (source || 'unknown') + '</strong> ' + (isCommercial ? 'ðŸ’° Commercial' : '');
        
        var badge = document.getElementById('transmission-badge');
        badge.className = 'badge ' + (isRealTime ? 'bg-success' : 'bg-warning');
        badge.textContent = isRealTime ? 'LIVE' : 'EMPIRICAL';
        
        document.getElementById('live-status-text').textContent = isRealTime ? 'LIVE' : 'EMPIRICAL';
        document.getElementById('live-status-text').className = isRealTime ? 'fw-semibold text-success me-3' : 'fw-semibold text-warning me-3';
        document.getElementById('data-source-badge').textContent = isRealTime ? 'LIVE' : 'EMPIRICAL';
        document.getElementById('data-source-badge').className = 'badge ' + (isRealTime ? 'bg-success' : 'bg-warning');
    }
    
    function updateUITransmissionIdle() {
        var alert = document.getElementById('transmission-alert');
        alert.className = 'alert alert-secondary mb-4';
        
        document.getElementById('transmission-icon').className = 'fas fa-search fa-2x me-3';
        document.getElementById('transmission-title').innerHTML = 'WAITING FOR VESSEL';
        document.getElementById('transmission-message').textContent = 'System is scanning for vessels in Bergen area - REAL-TIME FIRST';
        document.getElementById('transmission-source').innerHTML = '';
        
        var badge = document.getElementById('transmission-badge');
        badge.className = 'badge bg-secondary';
        badge.textContent = 'WAITING';
        
        document.getElementById('live-status-text').textContent = 'WAITING';
        document.getElementById('live-status-text').className = 'fw-semibold text-secondary me-3';
        document.getElementById('data-source-badge').textContent = 'WAITING';
        document.getElementById('data-source-badge').className = 'badge bg-secondary';
    }
    
    function updateNorwegianTime() {
        var now = new Date();
        var timeElement = document.getElementById('local-time-norway');
        var dateElement = document.getElementById('norwegian-date');
        var mapUpdate = document.getElementById('map-update-time');
        
        if (timeElement) {
            timeElement.textContent = now.toLocaleTimeString('en-GB', { 
                timeZone: 'Europe/Oslo', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false 
            });
        }
        
        if (dateElement) {
            dateElement.textContent = now.toLocaleDateString('en-GB', { 
                timeZone: 'Europe/Oslo',
                weekday: 'short',
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }
        
        if (mapUpdate) {
            mapUpdate.textContent = 'Updated: ' + now.toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit'
            });
        }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ðŸš¢ REAL-TIME VESSEL ANALYSIS starting...');
        
        setTimeout(function() {
            if (window.rtzWaypoints) {
                var routesData = document.getElementById('routes-data');
                if (routesData && routesData.textContent) {
                    try {
                        var routes = JSON.parse(routesData.textContent);
                        if (routes && routes.length > 0) {
                            window.rtzWaypoints.drawMultipleRoutes(routes);
                            document.getElementById('route-count-badge').textContent = routes.length;
                            console.log('âœ… Loaded', routes.length, 'routes');
                        }
                    } catch (e) {
                        console.error('Error parsing routes:', e);
                    }
                }
            }
            
            startAnalysisTracking();
            updateNorwegianTime();
            setInterval(updateNorwegianTime, 1000);
        }, 1500);
    });
    
    // Cleanup
    window.addEventListener('beforeunload', function() {
        if (analysisUpdateInterval) {
            clearInterval(analysisUpdateInterval);
        }
        if (analysisDataInterval) {
            clearInterval(analysisDataInterval);
        }
    });
    
})();
</script>
{% endblock %}