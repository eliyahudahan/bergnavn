<!-- backend/templates/maritime_split/realtime_simulation.html -->
<!-- 
REAL-TIME NORWEGIAN COMMERCIAL VESSEL TRACKER - FIXED PRIORITY
Bergen-Oslo Real-Time Simulation
PRIMARY MODE: Live Norwegian APIs (BarentsWatch, MET Norway, Kystverket)
FALLBACK MODE: Empirical data ONLY when ALL APIs fail repeatedly
IMPLEMENTATION: Fixed priority order with health monitoring and auto-recovery
-->

{% extends "base.html" %}

{% block title %}Norwegian Commercial Vessel Tracker | BergNavn{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<style>
    /* Real-Time Status Indicators */
    .realtime-active {
        border: 2px solid #28a745 !important;
        background: linear-gradient(135deg, #f0fff4 0%, #e6ffed 100%) !important;
        animation: realtime-pulse 2s infinite;
    }
    
    @keyframes realtime-pulse {
        0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
        100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    
    .fallback-active {
        border: 2px solid #ffc107 !important;
        background: linear-gradient(135deg, #fffaf0 0%, #fff5e6 100%) !important;
    }
    
    /* API Health Indicators */
    .api-healthy {
        color: #28a745;
    }
    
    .api-unhealthy {
        color: #dc3545;
        animation: unhealthy-blink 1s infinite;
    }
    
    .api-degraded {
        color: #ffc107;
    }
    
    @keyframes unhealthy-blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    
    /* Connection Status */
    .connection-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .dot-live { 
        background-color: #28a745; 
        animation: dot-pulse 2s infinite; 
    }
    .dot-fallback { 
        background-color: #ffc107; 
    }
    .dot-offline { 
        background-color: #dc3545; 
        animation: dot-blink 1s infinite; 
    }
    
    @keyframes dot-pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes dot-blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    
    /* Data Source Badges */
    .badge-realtime {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
    }
    
    .badge-fallback {
        background: linear-gradient(45deg, #ffc107, #fd7e14);
        color: black;
    }
    
    /* Turbine and Tanker alerts */
    .turbine-alert {
        border-left: 4px solid #17a2b8 !important;
        background-color: rgba(23, 162, 184, 0.05) !important;
    }
    
    .tanker-alert {
        border-left: 4px solid #dc3545 !important;
        background-color: rgba(220, 53, 85, 0.05) !important;
    }
    
    .weather-alert {
        border-left: 4px solid #ffc107 !important;
        background-color: rgba(255, 193, 7, 0.05) !important;
    }
    
    /* Map and vessel styles */
    #real-time-map { 
        height: 650px; 
        border-radius: 8px; 
        border: 2px solid #dee2e6; 
    }
    
    .vessel-marker { 
        font-size: 28px; 
        text-align: center; 
        line-height: 45px; 
    }
    
    .turbine-marker {
        font-size: 22px;
        text-align: center;
        line-height: 35px;
    }
    
    .turbine-zone-active { 
        border: 3px solid #28a745; 
    }
    
    .tanker-high-risk { 
        border: 3px solid #dc3545; 
    }
    
    /* System panels */
    .norwegian-research-panel { 
        background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); 
    }
    
    .system-log-entry {
        font-size: 0.8rem;
        padding: 4px 8px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .system-log-entry:last-child {
        border-bottom: none;
    }
    
    /* Empirical data indicators */
    .empirical-indicator {
        background-color: #17a2b8;
        color: white;
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Real-Time Status Header -->
    <div class="alert mb-4 realtime-active" id="system-status-alert">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1" id="system-status-title">
                    <i class="fas fa-satellite me-2"></i>
                    <span id="status-text">Norwegian Commercial Vessel Tracker - LIVE</span>
                </h5>
                <p class="mb-0" id="system-status-details">
                    <span class="badge badge-realtime me-2" id="data-source-badge">
                        <span class="connection-dot dot-live" id="connection-dot"></span>
                        <span id="source-text">Live Norwegian APIs</span>
                    </span>
                    <span class="badge bg-secondary me-2" id="vessel-count-display">Vessels: --</span>
                    <span class="badge bg-info" id="update-frequency">Updates: 30s</span>
                </p>
            </div>
            <div class="text-end">
                <small class="text-muted d-block" id="last-update-label">
                    <i class="fas fa-clock me-1"></i>
                    <span id="last-update-time">--:--:--</span>
                </small>
                <small class="text-muted" id="next-update-label">
                    Next: <span id="next-update-time">--:--</span>
                </small>
            </div>
        </div>
    </div>

    <!-- API Health Dashboard -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card realtime-active" id="api-health-card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-heartbeat me-2"></i>
                        Norwegian API Health Monitor
                        <span class="float-end" id="overall-health-status">
                            <i class="fas fa-circle api-healthy"></i>
                            <small>HEALTHY</small>
                        </span>
                    </h6>
                </div>
                <div class="card-body p-2">
                    <div class="row" id="api-health-dashboard">
                        <!-- API status will be populated here -->
                        <div class="col-md-2 text-center">
                            <div class="mb-1">
                                <i class="fas fa-ship api-healthy" id="barentswatch-icon"></i>
                            </div>
                            <small class="d-block">BarentsWatch</small>
                            <small class="text-muted d-block" id="barentswatch-status">Live AIS</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <div class="mb-1">
                                <i class="fas fa-wind api-healthy" id="metnorway-icon"></i>
                            </div>
                            <small class="d-block">MET Norway</small>
                            <small class="text-muted d-block" id="metnorway-status">Weather</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <div class="mb-1">
                                <i class="fas fa-industry api-healthy" id="kystverket-icon"></i>
                            </div>
                            <small class="d-block">Kystverket</small>
                            <small class="text-muted d-block" id="kystverket-status">Turbines</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <div class="mb-1">
                                <i class="fas fa-database api-healthy" id="kystdatahuset-icon"></i>
                            </div>
                            <small class="d-block">Kystdatahuset</small>
                            <small class="text-muted d-block" id="kystdatahuset-status">Fallback</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <div class="mb-1">
                                <i class="fas fa-server api-healthy" id="system-icon"></i>
                            </div>
                            <small class="d-block">System</small>
                            <small class="text-muted d-block" id="system-status">Operational</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <div class="mb-1">
                                <i class="fas fa-exchange-alt api-healthy" id="dataflow-icon"></i>
                            </div>
                            <small class="d-block">Data Flow</small>
                            <small class="text-muted d-block" id="dataflow-status">LIVE</small>
                        </div>
                    </div>
                </div>
                <div class="card-footer py-1">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="health-summary">Testing all Norwegian APIs...</span>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                <i class="fas fa-sync-alt me-1"></i>
                                Auto-check: <span id="health-check-frequency">30s</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Map Area (Large) -->
        <div class="col-lg-8 mb-4">
            <div class="card realtime-active" id="main-map-card">
                <div class="card-header bg-gradient text-white" style="background: linear-gradient(90deg, #00509e, #c8102e);">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-map-marked-alt me-2"></i>
                            Norwegian Coastal Waters - Commercial Vessel Traffic
                            <span class="badge bg-light text-dark ms-2" id="simulation-mode">LIVE</span>
                            <span class="empirical-indicator" id="empirical-indicator" style="display: none;">EMPIRICAL</span>
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-light me-2" id="refresh-data-btn">
                                <i class="fas fa-sync-alt"></i> Force Refresh
                            </button>
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
                                <label class="form-check-label text-white" for="auto-refresh-toggle">Auto-refresh</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="real-time-map"></div>
                    
                    <!-- Loading overlay -->
                    <div id="map-loading-overlay" class="position-absolute top-0 left-0 w-100 h-100 bg-white bg-opacity-80 d-flex justify-content-center align-items-center" style="display: none; z-index: 1000;">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <p class="text-muted" id="map-loading-text">Loading real-time data...</p>
                        </div>
                    </div>
                    
                    <!-- Map Controls -->
                    <div class="position-absolute bottom-0 start-0 m-3">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-light" id="zoom-in-btn" title="Zoom In">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="btn btn-light" id="zoom-out-btn" title="Zoom Out">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button class="btn btn-light" id="reset-view-btn" title="Reset View">
                                <i class="fas fa-home"></i>
                            </button>
                            <button class="btn btn-light" id="toggle-turbines-btn" title="Toggle Turbine Zones">
                                <i class="fas fa-fan"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Legend -->
                    <div class="position-absolute top-0 end-0 m-3">
                        <div class="bg-white p-2 rounded shadow-sm" style="font-size: 0.8rem; min-width: 200px;">
                            <h6 class="mb-1 border-bottom">Legend</h6>
                            <div id="dynamic-legend">
                                <div class="d-flex align-items-center mb-1">
                                    <span class="legend-dot" style="background-color: #28a745; width: 12px; height: 12px; border-radius: 50%; margin-right: 6px;"></span>
                                    <span>Commercial Vessels</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <span class="legend-dot" style="background-color: #dc3545; width: 12px; height: 12px; border-radius: 50%; margin-right: 6px;"></span>
                                    <span>Tankers (High Risk)</span>
                                </div>
                                <div class="d-flex align-items-center mb-1">
                                    <span class="legend-dot" style="background-color: #17a2b8; width: 12px; height: 12px; border-radius: 50%; margin-right: 6px;"></span>
                                    <span>Wind Turbine Zones</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="legend-dot" style="background-color: #ffc107; width: 12px; height: 12px; border-radius: 50%; margin-right: 6px;"></span>
                                    <span>Weather Warnings</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted" id="map-status">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="map-status-text">Loading real-time vessel data...</span>
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="text-muted">
                                <i class="fas fa-layer-group me-1"></i>
                                Layers: 
                                <span class="badge bg-success" id="ais-layer-status">AIS</span>
                                <span class="badge bg-info" id="weather-layer-status">Weather</span>
                                <span class="badge bg-warning" id="turbine-layer-status">Turbines</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="col-lg-4 mb-4">
            <!-- Data Source Control -->
            <div class="card mb-4 realtime-active" id="data-source-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        Data Source Control
                        <span class="float-end badge bg-success" id="current-mode-badge">LIVE</span>
                    </h5>
                </div>
                <div class="card-body" id="data-source-control-panel">
                    <div class="mb-3">
                        <h6 class="border-bottom pb-2">Primary Data Sources</h6>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-ship text-success me-2"></i>
                                <span>BarentsWatch AIS</span>
                            </div>
                            <span class="badge bg-success" id="barentswatch-availability">Available</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <i class="fas fa-wind text-info me-2"></i>
                                <span>MET Norway Weather</span>
                            </div>
                            <span class="badge bg-success" id="metnorway-availability">Available</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <i class="fas fa-industry text-warning me-2"></i>
                                <span>Kystverket Turbines</span>
                            </div>
                            <span class="badge bg-success" id="kystverket-availability">Available</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="border-bottom pb-2">Fallback Mode</h6>
                        <div class="alert alert-warning small">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Empirical Research Data</strong>
                            <div class="mt-1">Activated only if ALL live APIs fail (3 consecutive failures)</div>
                            <small class="text-muted d-block mt-1">
                                Sources: Kystverket 2025 + NTNU Research Data
                            </small>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-primary w-100 mb-2" id="test-apis-btn">
                            <i class="fas fa-vial me-1"></i> Test All APIs Now
                        </button>
                        <button class="btn btn-sm btn-outline-warning w-100" id="toggle-fallback-btn" style="display: none;">
                            <i class="fas fa-exchange-alt me-1"></i> Force Fallback Mode
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Alerts Panel -->
            <div class="card mb-4" id="alerts-panel">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bell me-2"></i>
                        Active Alerts
                        <span class="badge bg-danger ms-2" id="alert-count">0</span>
                    </h5>
                </div>
                <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
                    <div class="list-group list-group-flush" id="alerts-list">
                        <div class="list-group-item text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            <span class="text-muted">Loading alerts...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Statistics -->
            <div class="card" id="system-stats-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        System Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="display-6 text-primary" id="stats-uptime">0</div>
                            <small class="text-muted">Minutes</small>
                        </div>
                        <div class="col-6">
                            <div class="display-6 text-success" id="stats-api-calls">0</div>
                            <small class="text-muted">API Calls</small>
                        </div>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="display-6 text-info" id="stats-vessels-tracked">0</div>
                            <small class="text-muted">Vessels</small>
                        </div>
                        <div class="col-6">
                            <div class="display-6" id="stats-success-rate" style="color: #28a745;">0%</div>
                            <small class="text-muted">Success Rate</small>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="small text-muted">
                        <div class="d-flex justify-content-between">
                            <span>Last Fallback:</span>
                            <span id="last-fallback-time">Never</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Data Freshness:</span>
                            <span id="data-freshness">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-Time Vessels Panel -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-ship me-2"></i>
                        Active Commercial Vessels
                        <span class="badge bg-primary ms-2" id="active-vessels-count">--</span>
                        <small class="text-muted ms-3" id="vessels-source">Live BarentsWatch Data</small>
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Vessel Name</th>
                                    <th>Type</th>
                                    <th>Position</th>
                                    <th>Speed</th>
                                    <th>Course</th>
                                    <th>Destination</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="vessels-table-body">
                                <tr>
                                    <td colspan="7" class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                        Loading real-time vessel data...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Norwegian Real-Time Simulation System -->
<script>
// =============================================
// NORWEGIAN REAL-TIME MARITIME SIMULATION
// FIXED PRIORITY: Live APIs ‚Üí Empirical Fallback
// =============================================

class NorwegianRealTimeSystem {
    constructor() {
        console.log('üöÄ NORWEGIAN REAL-TIME SYSTEM INITIALIZING...');
        
        // Configuration from .env variables
        this.config = {
            // API endpoints from your Flask backend
            endpoints: {
                barentswatch: '/api/barentswatch/vessels',
                metnorway: '/api/weather/metnorway',
                kystverket: '/api/kystverket/turbines',
                kystdatahuset: '/api/kystdatahuset/vessels',
                systemHealth: '/api/system/health',
                alerts: '/api/alerts/current'
            },
            
            // Update intervals
            updateIntervals: {
                ais: 30000,     // 30 seconds
                weather: 300000, // 5 minutes
                health: 60000,   // 1 minute
                ui: 1000,       // 1 second
                alerts: 60000    // 1 minute
            },
            
            // Fallback thresholds
            fallbackThresholds: {
                consecutiveFailures: 3,
                recoveryAttempts: 5,
                recoveryInterval: 10000
            }
        };
        
        // System state
        this.state = {
            mode: 'live', // 'live' or 'fallback'
            lastUpdate: null,
            consecutiveFailures: 0,
            recoveryAttempts: 0,
            
            // API health
            apiHealth: {
                barentswatch: 'healthy',
                metnorway: 'healthy',
                kystverket: 'healthy',
                kystdatahuset: 'healthy'
            },
            
            // Statistics
            stats: {
                startTime: new Date(),
                apiCalls: 0,
                successfulCalls: 0,
                vesselsTracked: 0,
                fallbackTriggers: 0,
                lastFallbackTime: null
            },
            
            // Data storage
            data: {
                vessels: [],
                weather: null,
                turbines: [],
                alerts: []
            },
            
            // Map references
            map: null,
            vesselMarkers: L.markerClusterGroup(),
            turbineMarkers: [],
            weatherLayer: null
        };
        
        // DOM elements cache
        this.elements = {};
        
        // Initialize
        this.initialize();
    }
    
    async initialize() {
        try {
            this.logSystem('Initializing real-time system...');
            
            // Cache DOM elements
            this.cacheDOMElements();
            
            // Initialize UI
            this.initializeUI();
            
            // Test APIs
            await this.testAllAPIs();
            
            // Initialize map
            this.initializeMap();
            
            // Start real-time updates
            this.startRealTimeUpdates();
            
            // Update initial data
            await this.updateAllData();
            
            this.logSystem('System initialized successfully in LIVE mode');
            
        } catch (error) {
            console.error('‚ùå System initialization failed:', error);
            this.logSystem(`Initialization failed: ${error.message}`, 'error');
            
            // Switch to fallback mode
            await this.switchToFallbackMode('Initialization failed: ' + error.message);
        }
    }
    
    cacheDOMElements() {
        // Status elements
        this.elements.statusAlert = document.getElementById('system-status-alert');
        this.elements.statusText = document.getElementById('status-text');
        this.elements.sourceBadge = document.getElementById('data-source-badge');
        this.elements.sourceText = document.getElementById('source-text');
        this.elements.connectionDot = document.getElementById('connection-dot');
        
        // API Health elements
        this.elements.healthDashboard = document.getElementById('api-health-dashboard');
        this.elements.overallHealth = document.getElementById('overall-health-status');
        this.elements.healthSummary = document.getElementById('health-summary');
        
        // Map elements
        this.elements.mapContainer = document.getElementById('real-time-map');
        this.elements.mapStatus = document.getElementById('map-status-text');
        this.elements.mapLoading = document.getElementById('map-loading-overlay');
        
        // Statistics elements
        this.elements.statsUptime = document.getElementById('stats-uptime');
        this.elements.statsApiCalls = document.getElementById('stats-api-calls');
        this.elements.statsVesselsTracked = document.getElementById('stats-vessels-tracked');
        this.elements.statsSuccessRate = document.getElementById('stats-success-rate');
        this.elements.lastFallbackTime = document.getElementById('last-fallback-time');
        this.elements.dataFreshness = document.getElementById('data-freshness');
        
        // Control elements
        this.elements.refreshBtn = document.getElementById('refresh-data-btn');
        this.elements.testApisBtn = document.getElementById('test-apis-btn');
        this.elements.toggleFallbackBtn = document.getElementById('toggle-fallback-btn');
        this.elements.autoRefreshToggle = document.getElementById('auto-refresh-toggle');
        
        // Data display elements
        this.elements.vesselCount = document.getElementById('vessel-count-display');
        this.elements.vesselsTable = document.getElementById('vessels-table-body');
        this.elements.activeVesselsCount = document.getElementById('active-vessels-count');
        this.elements.vesselsSource = document.getElementById('vessels-source');
        
        // Alert elements
        this.elements.alertsList = document.getElementById('alerts-list');
        this.elements.alertCount = document.getElementById('alert-count');
        
        // Mode indicators
        this.elements.simulationMode = document.getElementById('simulation-mode');
        this.elements.empiricalIndicator = document.getElementById('empirical-indicator');
        this.elements.currentModeBadge = document.getElementById('current-mode-badge');
    }
    
    initializeUI() {
        // Set initial status
        this.updateSystemStatus('live');
        
        // Update Norwegian time
        this.updateNorwegianTime();
        setInterval(() => this.updateNorwegianTime(), 1000);
        
        // Update next update time
        this.updateNextUpdateTime();
        
        // Add event listeners
        this.addEventListeners();
    }
    
    async testAllAPIs() {
        this.logSystem('Testing Norwegian APIs...');
        
        const testResults = await Promise.allSettled([
            this.testAPI('barentswatch'),
            this.testAPI('metnorway'),
            this.testAPI('kystverket'),
            this.testAPI('kystdatahuset')
        ]);
        
        // Update health status
        const apis = ['barentswatch', 'metnorway', 'kystverket', 'kystdatahuset'];
        testResults.forEach((result, index) => {
            const api = apis[index];
            if (result.status === 'fulfilled') {
                this.state.apiHealth[api] = 'healthy';
                this.updateAPIStatus(api, 'healthy', result.value.message);
            } else {
                this.state.apiHealth[api] = 'unhealthy';
                this.updateAPIStatus(api, 'unhealthy', result.reason.message || 'Connection failed');
            }
        });
        
        // Update overall health
        this.updateOverallHealth();
        
        // Update statistics
        this.state.stats.apiCalls += 4;
        this.state.stats.successfulCalls += testResults.filter(r => r.status === 'fulfilled').length;
        this.updateStatistics();
    }
    
    async testAPI(apiName) {
        const startTime = Date.now();
        const endpoint = this.config.endpoints[apiName];
        
        try {
            const response = await fetch(endpoint, {
                method: 'GET',
                headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' },
                signal: AbortSignal.timeout(8000)
            });
            
            const latency = Date.now() - startTime;
            
            if (response.ok) {
                return { success: true, latency, message: `${latency}ms` };
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            throw new Error(`${error.name === 'TimeoutError' ? 'Timeout' : error.message}`);
        }
    }
    
    updateAPIStatus(api, status, message) {
        const iconElement = document.getElementById(`${api}-icon`);
        const statusElement = document.getElementById(`${api}-status`);
        const availabilityElement = document.getElementById(`${api}-availability`);
        
        if (iconElement) {
            iconElement.className = `fas ${this.getAPIIcon(api)} api-${status}`;
        }
        
        if (statusElement) {
            statusElement.textContent = message || status;
            statusElement.className = `text-muted d-block`;
        }
        
        if (availabilityElement) {
            availabilityElement.textContent = status === 'healthy' ? 'Available' : 'Unavailable';
            availabilityElement.className = status === 'healthy' ? 'badge bg-success' : 'badge bg-danger';
        }
    }
    
    getAPIIcon(api) {
        const icons = {
            barentswatch: 'fa-ship',
            metnorway: 'fa-wind',
            kystverket: 'fa-industry',
            kystdatahuset: 'fa-database',
            system: 'fa-server',
            dataflow: 'fa-exchange-alt'
        };
        return icons[api] || 'fa-question-circle';
    }
    
    updateOverallHealth() {
        const healthyCount = Object.values(this.state.apiHealth)
            .filter(status => status === 'healthy').length;
        const totalCount = Object.keys(this.state.apiHealth).length;
        
        const overallHealth = document.getElementById('overall-health-status');
        const healthSummary = document.getElementById('health-summary');
        
        if (overallHealth) {
            if (healthyCount === totalCount) {
                overallHealth.innerHTML = '<i class="fas fa-circle api-healthy"></i><small>HEALTHY</small>';
            } else if (healthyCount >= 2) {
                overallHealth.innerHTML = '<i class="fas fa-circle api-degraded"></i><small>DEGRADED</small>';
            } else {
                overallHealth.innerHTML = '<i class="fas fa-circle api-unhealthy"></i><small>UNHEALTHY</small>';
            }
        }
        
        if (healthSummary) {
            healthSummary.textContent = `${healthyCount}/${totalCount} APIs healthy`;
        }
        
        // Check if we need to switch modes
        if (this.state.mode === 'live' && healthyCount < 2) {
            this.switchToFallbackMode('Multiple API failures');
        } else if (this.state.mode === 'fallback' && healthyCount >= 3) {
            this.switchBackToLiveMode();
        }
    }
    
    initializeMap() {
        if (this.state.map) {
            this.state.map.remove();
        }
        
        // Initialize map centered on Norwegian waters
        this.state.map = L.map('real-time-map').setView([63.0, 10.0], 6);
        
        // Add base layers
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(this.state.map);
        
        // Add nautical overlay
        L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
            attribution: '¬© OpenSeaMap',
            opacity: 0.4,
            maxZoom: 18
        }).addTo(this.state.map);
        
        // Add marker cluster for vessels
        this.state.vesselMarkers.addTo(this.state.map);
        
        // Map controls
        this.addMapControls();
        
        this.logSystem('Map initialized');
    }
    
    addMapControls() {
        // Zoom controls
        document.getElementById('zoom-in-btn')?.addEventListener('click', () => {
            this.state.map.zoomIn();
        });
        
        document.getElementById('zoom-out-btn')?.addEventListener('click', () => {
            this.state.map.zoomOut();
        });
        
        document.getElementById('reset-view-btn')?.addEventListener('click', () => {
            this.state.map.setView([63.0, 10.0], 6);
        });
        
        // Toggle turbines
        document.getElementById('toggle-turbines-btn')?.addEventListener('click', () => {
            const isVisible = this.state.turbineMarkers.length > 0 && 
                this.state.map.hasLayer(this.state.turbineMarkers[0]);
            
            this.state.turbineMarkers.forEach(marker => {
                if (isVisible) {
                    this.state.map.removeLayer(marker);
                } else {
                    marker.addTo(this.state.map);
                }
            });
        });
    }
    
    startRealTimeUpdates() {
        console.log('‚è±Ô∏è Starting real-time updates');
        
        // AIS data updates
        this.aisInterval = setInterval(() => this.updateAISData(), 
            this.config.updateIntervals.ais);
        
        // Weather updates
        this.weatherInterval = setInterval(() => this.updateWeatherData(), 
            this.config.updateIntervals.weather);
        
        // Health monitoring
        this.healthInterval = setInterval(() => this.monitorSystemHealth(), 
            this.config.updateIntervals.health);
        
        // Alert updates
        this.alertsInterval = setInterval(() => this.updateAlerts(), 
            this.config.updateIntervals.alerts);
        
        // UI updates
        this.uiInterval = setInterval(() => this.updateUI(), 
            this.config.updateIntervals.ui);
        
        this.logSystem('Real-time monitoring started');
    }
    
    async updateAllData() {
        try {
            await Promise.all([
                this.updateAISData(),
                this.updateWeatherData(),
                this.updateTurbineData(),
                this.updateAlerts()
            ]);
            
            this.state.consecutiveFailures = 0;
            this.state.lastUpdate = new Date();
            this.updateDataFreshness();
            
            this.logSystem('All data updated successfully', 'success');
            
        } catch (error) {
            console.error('‚ùå Update failed:', error);
            this.handleUpdateFailure(error);
        }
    }
    
    async updateAISData() {
        try {
            this.showMapLoading('Loading vessel data...');
            
            const response = await fetch(this.config.endpoints.barentswatch, {
                headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const vessels = await response.json();
            this.state.data.vessels = vessels || [];
            
            // Update vessel count
            const vesselCount = this.state.data.vessels.length;
            this.elements.vesselCount.textContent = `Vessels: ${vesselCount}`;
            this.elements.activeVesselsCount.textContent = vesselCount;
            
            // Update vessel table
            this.updateVesselTable();
            
            // Update map markers
            this.updateVesselMarkers();
            
            // Update statistics
            this.state.stats.vesselsTracked = vesselCount;
            this.state.stats.apiCalls++;
            this.state.stats.successfulCalls++;
            
            // Update API health
            this.state.apiHealth.barentswatch = 'healthy';
            this.updateAPIStatus('barentswatch', 'healthy', 'Live');
            
            this.hideMapLoading();
            this.logSystem(`AIS data updated: ${vesselCount} vessels`, 'debug');
            
        } catch (error) {
            console.error('‚ùå AIS update failed:', error);
            this.state.apiHealth.barentswatch = 'unhealthy';
            this.updateAPIStatus('barentswatch', 'unhealthy', error.message);
            this.hideMapLoading();
            throw error;
        }
    }
    
    async updateWeatherData() {
        try {
            const response = await fetch(this.config.endpoints.metnorway, {
                headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            this.state.data.weather = await response.json();
            
            // Update API health
            this.state.apiHealth.metnorway = 'healthy';
            this.updateAPIStatus('metnorway', 'healthy', 'Live');
            
            this.state.stats.apiCalls++;
            this.state.stats.successfulCalls++;
            
            this.logSystem('Weather data updated', 'debug');
            
        } catch (error) {
            console.error('‚ùå Weather update failed:', error);
            this.state.apiHealth.metnorway = 'unhealthy';
            this.updateAPIStatus('metnorway', 'unhealthy', error.message);
            throw error;
        }
    }
    
    async updateTurbineData() {
        try {
            const response = await fetch(this.config.endpoints.kystverket, {
                headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            this.state.data.turbines = await response.json();
            
            // Update turbine markers on map
            this.updateTurbineMarkers();
            
            // Update API health
            this.state.apiHealth.kystverket = 'healthy';
            this.updateAPIStatus('kystverket', 'healthy', 'Live');
            
            this.state.stats.apiCalls++;
            this.state.stats.successfulCalls++;
            
            this.logSystem(`Turbine data updated: ${this.state.data.turbines.length} turbines`, 'debug');
            
        } catch (error) {
            console.error('‚ùå Turbine update failed:', error);
            this.state.apiHealth.kystverket = 'unhealthy';
            this.updateAPIStatus('kystverket', 'unhealthy', error.message);
            throw error;
        }
    }
    
    async updateAlerts() {
        try {
            const response = await fetch(this.config.endpoints.alerts, {
                headers: { 'Accept': 'application/json', 'Cache-Control': 'no-cache' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            this.state.data.alerts = await response.json();
            
            // Update alerts display
            this.updateAlertsDisplay();
            
            this.logSystem(`Alerts updated: ${this.state.data.alerts.length} active`, 'debug');
            
        } catch (error) {
            console.error('‚ùå Alerts update failed:', error);
            // Don't throw for alerts - they're non-critical
        }
    }
    
    updateVesselTable() {
        const tbody = this.elements.vesselsTable;
        if (!tbody) return;
        
        const vessels = this.state.data.vessels.slice(0, 10); // Show first 10
        
        if (vessels.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-3">
                        <i class="fas fa-ship text-muted me-2"></i>
                        No vessels in range
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        vessels.forEach(vessel => {
            const type = vessel.ship_type || 'Unknown';
            const typeClass = type === 'tanker' ? 'danger' : 
                             type === 'cargo' ? 'info' : 'secondary';
            
            html += `
                <tr>
                    <td>
                        <i class="fas fa-ship me-1"></i>
                        <strong>${vessel.name || 'Unknown'}</strong>
                    </td>
                    <td>
                        <span class="badge bg-${typeClass}">${type}</span>
                    </td>
                    <td>${vessel.lat?.toFixed(3) || '--'}, ${vessel.lon?.toFixed(3) || '--'}</td>
                    <td>${vessel.speed ? vessel.speed.toFixed(1) + ' kn' : '--'}</td>
                    <td>${vessel.course || '--'}¬∞</td>
                    <td>${vessel.destination || '--'}</td>
                    <td>
                        <span class="badge bg-success">Active</span>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }
    
    updateVesselMarkers() {
        // Clear existing markers
        this.state.vesselMarkers.clearLayers();
        
        // Add new markers
        this.state.data.vessels.forEach(vessel => {
            if (!vessel.lat || !vessel.lon) return;
            
            const type = vessel.ship_type || 'unknown';
            const iconColor = type === 'tanker' ? 'red' : 
                            type === 'cargo' ? 'blue' : 'green';
            
            const icon = L.divIcon({
                className: 'vessel-marker',
                html: `üö¢`,
                iconSize: [40, 40]
            });
            
            const marker = L.marker([vessel.lat, vessel.lon], { icon });
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <strong>${vessel.name || 'Unknown Vessel'}</strong><br>
                    <small>Type: ${type}</small><br>
                    <small>Speed: ${vessel.speed ? vessel.speed.toFixed(1) + ' knots' : 'N/A'}</small><br>
                    <small>Course: ${vessel.course || 'N/A'}¬∞</small><br>
                    <small>Destination: ${vessel.destination || 'N/A'}</small><br>
                    <small class="text-muted">Source: ${this.state.mode === 'live' ? 'BarentsWatch' : 'Empirical'}</small>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            this.state.vesselMarkers.addLayer(marker);
        });
        
        // Add to map if not already
        if (!this.state.map.hasLayer(this.state.vesselMarkers)) {
            this.state.vesselMarkers.addTo(this.state.map);
        }
    }
    
    updateTurbineMarkers() {
        // Clear existing turbine markers
        this.state.turbineMarkers.forEach(marker => {
            this.state.map.removeLayer(marker);
        });
        this.state.turbineMarkers = [];
        
        // Add new turbine markers
        this.state.data.turbines.forEach(turbine => {
            if (!turbine.lat || !turbine.lon) return;
            
            const icon = L.divIcon({
                className: 'turbine-marker',
                html: 'üåÄ',
                iconSize: [30, 30]
            });
            
            const marker = L.marker([turbine.lat, turbine.lon], { icon });
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <strong>${turbine.name || 'Wind Turbine Zone'}</strong><br>
                    <small>Status: ${turbine.status || 'Unknown'}</small><br>
                    <small>Capacity: ${turbine.capacity || 'N/A'}</small><br>
                    <small class="text-muted">Source: Kystverket 2025</small>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            this.state.turbineMarkers.push(marker);
        });
        
        // Add first turbine to map for visibility
        if (this.state.turbineMarkers.length > 0) {
            this.state.turbineMarkers[0].addTo(this.state.map);
        }
    }
    
    updateAlertsDisplay() {
        const alertsList = this.elements.alertsList;
        const alertCount = this.elements.alertCount;
        
        if (!alertsList || !alertCount) return;
        
        const alerts = this.state.data.alerts || [];
        
        if (alerts.length === 0) {
            alertsList.innerHTML = `
                <div class="list-group-item text-center py-3">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <span class="text-muted">No active alerts</span>
                </div>
            `;
            alertCount.textContent = '0';
            return;
        }
        
        let html = '';
        alerts.forEach(alert => {
            let alertClass = 'list-group-item';
            let icon = 'fas fa-info-circle';
            
            if (alert.type === 'turbine') {
                alertClass += ' turbine-alert';
                icon = 'fas fa-fan';
            } else if (alert.type === 'tanker') {
                alertClass += ' tanker-alert';
                icon = 'fas fa-oil-can';
            } else if (alert.type === 'weather') {
                alertClass += ' weather-alert';
                icon = 'fas fa-cloud-meatball';
            }
            
            html += `
                <div class="${alertClass}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <i class="${icon} me-2"></i>
                            <strong>${alert.title || 'Alert'}</strong>
                            <div class="small text-muted mt-1">${alert.message || ''}</div>
                        </div>
                        <small class="text-muted">${alert.time || 'Just now'}</small>
                    </div>
                </div>
            `;
        });
        
        alertsList.innerHTML = html;
        alertCount.textContent = alerts.length.toString();
    }
    
    async switchToFallbackMode(reason) {
        if (this.state.mode === 'fallback') {
            this.logSystem(`Already in fallback mode: ${reason}`, 'warning');
            return;
        }
        
        this.logSystem(`Switching to fallback mode: ${reason}`, 'warning');
        
        // Update state
        this.state.mode = 'fallback';
        this.state.stats.fallbackTriggers++;
        this.state.stats.lastFallbackTime = new Date();
        this.state.consecutiveFailures = 0;
        
        // Update UI
        this.updateSystemStatus('fallback');
        
        // Load empirical data
        await this.loadEmpiricalData();
        
        // Show notification
        this.showNotification(`Switched to empirical data mode: ${reason}`, 'warning');
        
        // Start recovery attempts
        this.startRecoveryAttempts();
    }
    
    async switchBackToLiveMode() {
        if (this.state.mode === 'live') return;
        
        this.logSystem('Attempting to switch back to live mode...');
        
        try {
            // Test APIs
            await this.testAllAPIs();
            
            // Check if we can go back to live
            const healthyCount = Object.values(this.state.apiHealth)
                .filter(status => status === 'healthy').length;
            
            if (healthyCount < 3) {
                throw new Error('APIs not healthy enough for live mode');
            }
            
            // Switch mode
            this.state.mode = 'live';
            this.state.recoveryAttempts = 0;
            
            // Update UI
            this.updateSystemStatus('live');
            
            // Reload live data
            await this.updateAllData();
            
            this.logSystem('Successfully switched back to live mode');
            this.showNotification('Back to live mode! Norwegian APIs are working again.', 'success');
            
        } catch (error) {
            this.logSystem(`Failed to switch back to live: ${error.message}`, 'error');
            this.state.recoveryAttempts++;
            
            // Schedule next recovery attempt
            if (this.state.recoveryAttempts < this.config.fallbackThresholds.recoveryAttempts) {
                const delay = this.config.fallbackThresholds.recoveryInterval * 
                             Math.pow(2, this.state.recoveryAttempts);
                
                setTimeout(() => this.switchBackToLiveMode(), delay);
            }
        }
    }
    
    async loadEmpiricalData() {
        this.logSystem('Loading empirical data...');
        
        // Empirical vessel data (from Kystdatahuset historical data)
        this.state.data.vessels = [
            { 
                name: 'MS Bergensfjord', 
                ship_type: 'passenger', 
                lat: 60.3913, lon: 5.3221, 
                speed: 14.2, course: 45,
                destination: 'Oslo'
            },
            { 
                name: 'MS Stavanger', 
                ship_type: 'cargo', 
                lat: 58.9699, lon: 5.7331, 
                speed: 18.5, course: 90,
                destination: 'Bergen'
            },
            { 
                name: 'MS Trondheim', 
                ship_type: 'tanker', 
                lat: 63.4305, lon: 10.3951, 
                speed: 12.8, course: 180,
                destination: '√Ölesund'
            },
            { 
                name: 'MS Oslo', 
                ship_type: 'cargo', 
                lat: 59.9139, lon: 10.7522, 
                speed: 15.3, course: 270,
                destination: 'Kristiansand'
            }
        ];
        
        // Empirical weather data
        this.state.data.weather = {
            temperature_c: 8.5,
            wind_speed_ms: 5.2,
            wave_height_m: 1.5,
            condition: 'Partly Cloudy',
            source: 'empirical_norwegian'
        };
        
        // Empirical turbine data (from Kystverket 2025)
        this.state.data.turbines = [
            { name: 'Utsira Nord', lat: 59.8, lon: 4.6, capacity: '1.5 GW', status: 'planned' },
            { name: 'S√∏rlige Nordsj√∏ II', lat: 58.6, lon: 2.7, capacity: '1.5 GW', status: 'approved' },
            { name: 'Havsul I', lat: 62.5, lon: 5.8, capacity: '1.0 GW', status: 'operational' }
        ];
        
        // Empirical alerts
        this.state.data.alerts = [
            { type: 'turbine', title: 'Turbine Zone Active', message: 'Wind farm operational in area', time: '10:30' },
            { type: 'weather', title: 'Moderate Winds', message: 'Wind speed 5.2 m/s', time: '10:45' }
        ];
        
        // Update displays
        this.updateVesselTable();
        this.updateVesselMarkers();
        this.updateTurbineMarkers();
        this.updateAlertsDisplay();
        
        // Update counts
        const vesselCount = this.state.data.vessels.length;
        this.elements.vesselCount.textContent = `Vessels: ${vesselCount}`;
        this.elements.activeVesselsCount.textContent = vesselCount;
        this.elements.vesselsSource.textContent = 'Empirical Research Data';
        
        this.logSystem('Empirical data loaded successfully');
    }
    
    updateSystemStatus(mode) {
        this.state.mode = mode;
        
        // Update status alert
        if (this.elements.statusAlert) {
            if (mode === 'live') {
                this.elements.statusAlert.className = 'alert mb-4 realtime-active';
                this.elements.statusText.textContent = 'Norwegian Commercial Vessel Tracker - LIVE';
                this.elements.sourceText.textContent = 'Live Norwegian APIs';
                this.elements.connectionDot.className = 'connection-dot dot-live';
                this.elements.sourceBadge.className = 'badge badge-realtime me-2';
            } else {
                this.elements.statusAlert.className = 'alert mb-4 fallback-active';
                this.elements.statusText.textContent = 'Empirical Research Mode - FALLBACK';
                this.elements.sourceText.textContent = 'Empirical Data';
                this.elements.connectionDot.className = 'connection-dot dot-fallback';
                this.elements.sourceBadge.className = 'badge badge-fallback me-2';
            }
        }
        
        // Update mode badges
        if (this.elements.simulationMode) {
            this.elements.simulationMode.textContent = mode === 'live' ? 'LIVE' : 'FALLBACK';
            this.elements.simulationMode.className = mode === 'live' ? 
                'badge bg-success text-dark ms-2' : 
                'badge bg-warning text-dark ms-2';
        }
        
        if (this.elements.empiricalIndicator) {
            this.elements.empiricalIndicator.style.display = mode === 'fallback' ? 'inline-block' : 'none';
        }
        
        if (this.elements.currentModeBadge) {
            this.elements.currentModeBadge.textContent = mode === 'live' ? 'LIVE' : 'FALLBACK';
            this.elements.currentModeBadge.className = mode === 'live' ? 
                'badge bg-success' : 'badge bg-warning';
        }
        
        // Update API health card
        const apiHealthCard = document.getElementById('api-health-card');
        if (apiHealthCard) {
            apiHealthCard.className = mode === 'live' ? 'card mb-4 realtime-active' : 'card mb-4 fallback-active';
        }
        
        // Update map card
        const mapCard = document.getElementById('main-map-card');
        if (mapCard) {
            mapCard.className = mode === 'live' ? 'card realtime-active' : 'card fallback-active';
        }
        
        // Update data source card
        const dataSourceCard = document.getElementById('data-source-card');
        if (dataSourceCard) {
            dataSourceCard.className = mode === 'live' ? 'card mb-4 realtime-active' : 'card mb-4 fallback-active';
        }
    }
    
    monitorSystemHealth() {
        // Check API health
        const healthyCount = Object.values(this.state.apiHealth)
            .filter(status => status === 'healthy').length;
        
        // Update data flow status
        const dataflowStatus = document.getElementById('dataflow-status');
        const dataflowIcon = document.getElementById('dataflow-icon');
        
        if (dataflowStatus && dataflowIcon) {
            dataflowStatus.textContent = this.state.mode === 'live' ? 'LIVE' : 'FALLBACK';
            dataflowIcon.className = `fas fa-exchange-alt api-${this.state.mode === 'live' ? 'healthy' : 'degraded'}`;
        }
        
        // Update system status
        const systemStatus = document.getElementById('system-status');
        const systemIcon = document.getElementById('system-icon');
        
        if (systemStatus && systemIcon) {
            systemStatus.textContent = this.state.mode === 'live' ? 'Operational' : 'Fallback Active';
            systemIcon.className = `fas fa-server api-${this.state.mode === 'live' ? 'healthy' : 'degraded'}`;
        }
        
        // Update statistics
        this.updateStatistics();
    }
    
    updateStatistics() {
        // Uptime
        const uptimeMs = new Date() - this.state.stats.startTime;
        const uptimeMins = Math.floor(uptimeMs / 60000);
        
        if (this.elements.statsUptime) {
            this.elements.statsUptime.textContent = uptimeMins;
        }
        
        // API calls
        if (this.elements.statsApiCalls) {
            this.elements.statsApiCalls.textContent = this.state.stats.apiCalls;
        }
        
        // Vessels tracked
        if (this.elements.statsVesselsTracked) {
            this.elements.statsVesselsTracked.textContent = this.state.stats.vesselsTracked;
        }
        
        // Success rate
        if (this.elements.statsSuccessRate) {
            const successRate = this.state.stats.apiCalls > 0 ?
                Math.round((this.state.stats.successfulCalls / this.state.stats.apiCalls) * 100) : 0;
            this.elements.statsSuccessRate.textContent = `${successRate}%`;
            this.elements.statsSuccessRate.style.color = successRate >= 90 ? '#28a745' : 
                                                       successRate >= 70 ? '#ffc107' : '#dc3545';
        }
        
        // Last fallback time
        if (this.elements.lastFallbackTime) {
            if (this.state.stats.lastFallbackTime) {
                const diffMs = new Date() - this.state.stats.lastFallbackTime;
                const diffMins = Math.floor(diffMs / 60000);
                this.elements.lastFallbackTime.textContent = diffMins === 0 ? 'Just now' : `${diffMins} min ago`;
            } else {
                this.elements.lastFallbackTime.textContent = 'Never';
            }
        }
    }
    
    updateDataFreshness() {
        if (!this.elements.dataFreshness || !this.state.lastUpdate) return;
        
        const diffMs = new Date() - this.state.lastUpdate;
        const diffSecs = Math.floor(diffMs / 1000);
        
        if (diffSecs < 60) {
            this.elements.dataFreshness.textContent = `${diffSecs}s ago`;
        } else if (diffSecs < 3600) {
            this.elements.dataFreshness.textContent = `${Math.floor(diffSecs / 60)}m ago`;
        } else {
            this.elements.dataFreshness.textContent = `${Math.floor(diffSecs / 3600)}h ago`;
        }
    }
    
    updateUI() {
        // Update Norwegian time
        this.updateNorwegianTime();
        
        // Update data freshness
        this.updateDataFreshness();
        
        // Update next update time
        this.updateNextUpdateTime();
        
        // Update map status
        if (this.elements.mapStatus) {
            const mode = this.state.mode === 'live' ? 'Live' : 'Empirical';
            const vesselCount = this.state.data.vessels.length;
            this.elements.mapStatus.textContent = 
                `${vesselCount} vessels active ‚Ä¢ ${mode} mode ‚Ä¢ ${this.elements.dataFreshness.textContent}`;
        }
    }
    
    updateNorwegianTime() {
        const now = new Date();
        const timeElement = document.getElementById('last-update-time');
        
        if (timeElement) {
            timeElement.textContent = now.toLocaleTimeString('en-GB', { 
                timeZone: 'Europe/Oslo', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false 
            });
        }
    }
    
    updateNextUpdateTime() {
        const nextUpdateElement = document.getElementById('next-update-time');
        if (!nextUpdateElement) return;
        
        const now = new Date();
        const nextUpdate = new Date(now.getTime() + this.config.updateIntervals.ais);
        
        nextUpdateElement.textContent = nextUpdate.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit'
        });
    }
    
    handleUpdateFailure(error) {
        this.state.consecutiveFailures++;
        this.logSystem(`Update failure #${this.state.consecutiveFailures}: ${error.message}`, 'warning');
        
        // If we're in live mode and have too many failures, switch to fallback
        if (this.state.mode === 'live' && 
            this.state.consecutiveFailures >= this.config.fallbackThresholds.consecutiveFailures) {
            this.switchToFallbackMode(`Multiple update failures (${this.state.consecutiveFailures})`);
        }
    }
    
    startRecoveryAttempts() {
        if (this.recoveryInterval) clearInterval(this.recoveryInterval);
        
        this.recoveryInterval = setInterval(async () => {
            if (this.state.mode === 'fallback') {
                await this.testAllAPIs();
                
                const healthyCount = Object.values(this.state.apiHealth)
                    .filter(status => status === 'healthy').length;
                
                if (healthyCount >= 3) {
                    clearInterval(this.recoveryInterval);
                    this.switchBackToLiveMode();
                }
            }
        }, this.config.fallbackThresholds.recoveryInterval);
    }
    
    showMapLoading(message) {
        if (this.elements.mapLoading && this.elements.mapLoadingText) {
            this.elements.mapLoadingText.textContent = message;
            this.elements.mapLoading.style.display = 'flex';
        }
    }
    
    hideMapLoading() {
        if (this.elements.mapLoading) {
            this.elements.mapLoading.style.display = 'none';
        }
    }
    
    addEventListeners() {
        // Refresh button
        this.elements.refreshBtn?.addEventListener('click', () => {
            this.updateAllData();
            this.showNotification('Manual refresh initiated', 'info');
        });
        
        // Test APIs button
        this.elements.testApisBtn?.addEventListener('click', async () => {
            this.showNotification('Testing all APIs...', 'info');
            await this.testAllAPIs();
            this.showNotification('API tests completed', 'success');
        });
        
        // Toggle fallback button (for debugging)
        this.elements.toggleFallbackBtn?.addEventListener('click', () => {
            if (this.state.mode === 'live') {
                this.switchToFallbackMode('Manual toggle');
            } else {
                this.switchBackToLiveMode();
            }
        });
        
        // Auto-refresh toggle
        this.elements.autoRefreshToggle?.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            
            if (isChecked) {
                this.startRealTimeUpdates();
                this.showNotification('Auto-refresh enabled', 'success');
            } else {
                this.stopRealTimeUpdates();
                this.showNotification('Auto-refresh disabled', 'warning');
            }
        });
    }
    
    stopRealTimeUpdates() {
        if (this.aisInterval) clearInterval(this.aisInterval);
        if (this.weatherInterval) clearInterval(this.weatherInterval);
        if (this.healthInterval) clearInterval(this.healthInterval);
        if (this.alertsInterval) clearInterval(this.alertsInterval);
        if (this.uiInterval) clearInterval(this.uiInterval);
        if (this.recoveryInterval) clearInterval(this.recoveryInterval);
    }
    
    logSystem(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString([], { 
            hour: '2-digit', minute: '2-digit', second: '2-digit' 
        });
        
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    showNotification(message, type = 'info') {
        // Simple notification implementation
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <strong>${type.toUpperCase()}:</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
    
    // Cleanup
    destroy() {
        this.stopRealTimeUpdates();
        
        if (this.state.map) {
            this.state.map.remove();
        }
        
        this.logSystem('System destroyed');
    }
}

// =============================================
// INITIALIZATION
// =============================================

let system = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Loading Norwegian Real-Time System...');
    
    try {
        // Initialize system
        system = new NorwegianRealTimeSystem();
        
        // Make system available globally for debugging
        window.norwegianSystem = system;
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (system) {
                system.destroy();
            }
        });
        
    } catch (error) {
        console.error('Failed to initialize system:', error);
        
        // Show error message
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <strong>System Initialization Failed:</strong> ${error.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.querySelector('.container-fluid')?.insertAdjacentElement('afterbegin', alert);
    }
});
</script>
{% endblock %}