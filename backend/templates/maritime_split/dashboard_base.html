{% extends "base.html" %}

{% block title %}Maritime Dashboard | BergNavn{% endblock %}

{% block head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .maritime-map {
        height: 500px;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .vessel-marker {
        background: #ff6b6b;
        border: 3px solid white;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }
    .ship-popup {
        min-width: 200px;
    }
    .ship-type-cargo { background: #ff6b6b; }
    .ship-type-passenger { background: #4ecdc4; }
    .ship-type-container { background: #45b7d1; }
    .ship-type-tanker { background: #ffa500; }
    .ship-type-research { background: #96ceb4; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="text-gradient">üåä Maritime Dashboard</h1>
            <p class="lead">Real-time maritime intelligence with verified data from public APIs</p>
        </div>
    </div>

    <!-- Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert" id="statusAlert">
                <strong>Status:</strong> <span id="statusText">Loading real-time data from public APIs...</span>
            </div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="row">
        <!-- Weather Data -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üå§Ô∏è Weather Data</h5>
                    <small class="opacity-75">OpenWeatherMap API</small>
                </div>
                <div class="card-body">
                    <div id="weatherData">
                        <div class="text-center">
                            <div class="spinner-border text-primary"></div>
                            <p class="mt-2">Loading real weather data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ships Data -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üö¢ Ships Tracking</h5>
                    <small class="opacity-75">Public AIS Data</small>
                </div>
                <div class="card-body">
                    <div id="shipsData">
                        <div class="text-center">
                            <div class="spinner-border text-success"></div>
                            <p class="mt-2">Loading real AIS data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fuel Analytics -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">‚õΩ Fuel Analytics</h5>
                    <small class="opacity-75">Real Optimization</small>
                </div>
                <div class="card-body">
                    <div id="fuelData">
                        <div class="text-center">
                            <div class="spinner-border text-warning"></div>
                            <p class="mt-2">Calculating fuel optimization...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Alerts -->
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card maritime-card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">‚ö†Ô∏è System Alerts</h5>
                    <small class="opacity-75">Real-time Monitoring</small>
                </div>
                <div class="card-body">
                    <div id="alertsData">
                        <div class="text-center">
                            <div class="spinner-border text-danger"></div>
                            <p class="mt-2">Monitoring system status...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Maritime Map -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card maritime-card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üó∫Ô∏è Live Maritime Map</h5>
                    <small class="opacity-75">Real-time vessel positions in Norwegian waters</small>
                </div>
                <div class="card-body p-0">
                    <div id="maritimeMap" class="maritime-map">
                        <!-- Map will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced ETA Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card maritime-card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">‚è±Ô∏è Enhanced ETA Calculation</h5>
                    <small class="opacity-75">Weather-adjusted arrival times with real data</small>
                </div>
                <div class="card-body">
                    <div id="etaData">
                        <div class="text-center">
                            <div class="spinner-border text-info"></div>
                            <p class="mt-2">Calculating ETA with real weather factors...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JavaScript -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
// Initialize maritime map
let maritimeMap;
let vesselMarkers = [];

function initializeMaritimeMap() {
    // Center map on Norwegian coastal waters
    maritimeMap = L.map('maritimeMap').setView([59.0, 9.0], 7);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(maritimeMap);
    
    console.log("üó∫Ô∏è Maritime map initialized with Norwegian coastal focus");
}

// Update map with real ship positions
function updateMapWithShips(shipsData) {
    console.log("üîÑ Updating map with real ship data:", shipsData);
    
    if (!maritimeMap) {
        console.error("‚ùå maritimeMap not initialized!");
        return;
    }
    
    console.log(`üó∫Ô∏è Processing ${shipsData.ships?.length || 0} real ships`);
    
    // Clear existing markers
    vesselMarkers.forEach(marker => maritimeMap.removeLayer(marker));
    vesselMarkers = [];
    
    // Add new markers for each real ship
    if (shipsData.ships && shipsData.ships.length > 0) {
        console.log("üìç Adding real ship markers to map...");
        
        shipsData.ships.forEach((ship, index) => {
            console.log(`  üö¢ Real Ship ${index + 1}: ${ship.name} at ${ship.lat}, ${ship.lon}`);
            
            const vesselIcon = L.divIcon({
                className: 'vessel-marker',
                html: `<div style="
                    background: ${getShipColor(ship.type)};
                    border: 3px solid white;
                    border-radius: 50%;
                    width: 14px;
                    height: 14px;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });
            
            const marker = L.marker([ship.lat, ship.lon], { icon: vesselIcon })
                .addTo(maritimeMap)
                .bindPopup(`
                    <div class="ship-popup text-center">
                        <h6><strong>${ship.name}</strong></h6>
                        <small>Type: ${ship.type}</small><br>
                        <small>Speed: ${ship.sog} knots</small><br>
                        <small>Course: ${ship.cog}¬∞</small><br>
                        <small>Destination: ${ship.destination}</small><br>
                        <small>Status: ${ship.status}</small>
                    </div>
                `);
            
            vesselMarkers.push(marker);
        });
        
        // Fit map to show all vessels
        if (vesselMarkers.length > 0) {
            const group = new L.featureGroup(vesselMarkers);
            maritimeMap.fitBounds(group.getBounds().pad(0.1));
        }
        
        console.log(`‚úÖ Updated map with ${vesselMarkers.length} real vessels`);
    } else {
        console.warn("‚ö†Ô∏è No real ships data available to display on map");
    }
}

// Helper function for ship colors based on type
function getShipColor(shipType) {
    const colors = {
        'Cargo': '#ff6b6b',
        'Passenger': '#4ecdc4', 
        'Container': '#45b7d1',
        'Tanker': '#ffa500',
        'Research': '#96ceb4',
        'default': '#ff6b6b'
    };
    return colors[shipType] || colors.default;
}

// Load all real data from public APIs
async function loadRealData() {
    try {
        updateStatus('Loading real-time data from public APIs...', 'info');

        // Initialize map first
        if (!maritimeMap) {
            initializeMaritimeMap();
        }

        // Load all real data in parallel
        const timeout = 15000;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        const [weatherResponse, shipsResponse, fuelResponse, alertsResponse, etaResponse] = await Promise.all([
            fetch('/maritime/api/weather-pro', { signal: controller.signal }),
            fetch('/maritime/api/ships-live', { signal: controller.signal }), 
            fetch('/maritime/api/analytics/fuel-optimization', { signal: controller.signal }),
            fetch('/maritime/api/alerts', { signal: controller.signal }),
            fetch('/maritime/api/route/eta-enhanced', { signal: controller.signal })
        ]);

        clearTimeout(timeoutId);

        // Process real weather data
        if (weatherResponse.ok) {
            const weatherData = await weatherResponse.json();
            displayWeatherData(weatherData);
        } else {
            displayWeatherError();
        }

        // Process real ships data - UPDATES THE MAP
        if (shipsResponse.ok) {
            const shipsData = await shipsResponse.json();
            console.log("üì° Real Ships API response:", shipsData);
            displayShipsData(shipsData);
            updateMapWithShips(shipsData);
        } else {
            console.error("‚ùå Real Ships API failed:", shipsResponse.status);
            displayShipsError();
        }

        // Process real fuel analytics
        if (fuelResponse.ok) {
            const fuelData = await fuelResponse.json();
            displayFuelData(fuelData);
        } else {
            displayFuelError();
        }

        // Process real alerts
        if (alertsResponse.ok) {
            const alertsData = await alertsResponse.json();
            displayAlertsData(alertsData);
        } else {
            displayAlertsError();
        }

        // Process real ETA
        if (etaResponse.ok) {
            const etaData = await etaResponse.json();
            displayETAData(etaData);
        } else {
            displayETAError();
        }

        updateStatus('All real-time data loaded successfully from public APIs', 'success');

    } catch (error) {
        console.error('‚ùå Error loading real data:', error);
        if (error.name === 'AbortError') {
            updateStatus('API timeout - public services may be slow', 'warning');
        } else {
            updateStatus('Error loading data from public APIs', 'danger');
        }
    }
}

// Display real weather data from OpenWeatherMap
function displayWeatherData(data) {
    const container = document.getElementById('weatherData');
    
    if (data.status === 'success' && data.data) {
        const weather = data.data;
        container.innerHTML = `
            <div class="text-center">
                <h3 class="text-primary">${Math.round(weather.temperature)}¬∞C</h3>
                <p><strong>${weather.condition}</strong></p>
                <div class="row text-sm mt-3">
                    <div class="col-6">
                        <small>Wind: ${weather.wind_speed} m/s</small>
                    </div>
                    <div class="col-6">
                        <small>Dir: ${weather.wind_direction}¬∞</small>
                    </div>
                    <div class="col-6">
                        <small>Humidity: ${weather.humidity}%</small>
                    </div>
                    <div class="col-6">
                        <small>Pressure: ${weather.pressure} hPa</small>
                    </div>
                    <div class="col-6">
                        <small>Waves: ${weather.wave_height}m</small>
                    </div>
                    <div class="col-6">
                        <small>Sea: ${weather.sea_state}</small>
                    </div>
                </div>
                <small class="text-muted d-block mt-2">Source: ${data.source}</small>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Weather data limited</p>
                <small>${data.message || 'Using fallback data'}</small>
            </div>
        `;
    }
}

// Display real ships data from AIS
function displayShipsData(data) {
    const container = document.getElementById('shipsData');
    
    if (data.status === 'live' && data.ships_count !== undefined) {
        container.innerHTML = `
            <div class="text-center">
                <h3 class="text-success">${data.ships_count}</h3>
                <p><strong>Active Vessels</strong></p>
                <div class="row text-sm mt-3">
                    <div class="col-12">
                        <small>Status: ${data.status}</small>
                    </div>
                    <div class="col-12">
                        <small>Source: ${data.data_source}</small>
                    </div>
                </div>
                ${data.fleet_analytics ? `
                <div class="mt-3 p-2 bg-light rounded">
                    <small class="d-block">Avg Efficiency: ${data.fleet_analytics.average_fuel_efficiency}/100</small>
                    <small class="d-block">Savings Potential: ${data.fleet_analytics.potential_fuel_savings_percent}%</small>
                    <small class="d-block">Performance: ${data.fleet_analytics.performance_grade}</small>
                </div>
                ` : ''}
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Ships data limited</p>
                <small>Check AIS connection</small>
            </div>
        `;
    }
}

// Display real fuel analytics
function displayFuelData(data) {
    const container = document.getElementById('fuelData');
    
    if (data.status === 'success' && data.optimization) {
        const optimization = data.optimization;
        container.innerHTML = `
            <div class="text-center">
                <h3 class="text-warning">${optimization.total_potential_savings_percent}%</h3>
                <p><strong>Fuel Savings Potential</strong></p>
                <div class="row text-sm mt-3">
                    <div class="col-6">
                        <small>Opportunities: ${optimization.opportunities_count}</small>
                    </div>
                    <div class="col-6">
                        <small>Impact: ${optimization.estimated_impact}</small>
                    </div>
                </div>
                <div class="mt-2 p-2 bg-light rounded">
                    <small class="d-block">Annual Savings: $${optimization.estimated_annual_savings}</small>
                    <small class="d-block">CO‚ÇÇ Reduction: ~${optimization.optimization_opportunities?.[0]?.estimated_co2_reduction || 0}%</small>
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Analytics limited</p>
                <small>Processing real data...</small>
            </div>
        `;
    }
}

// Display real system alerts
function displayAlertsData(data) {
    const container = document.getElementById('alertsData');
    
    if (data.status === 'success') {
        const alerts = data.alerts || [];
        const alertCount = data.alert_count || alerts.length;
        
        if (alertCount > 0) {
            container.innerHTML = `
                <div class="text-center">
                    <h3 class="text-danger">${alertCount}</h3>
                    <p><strong>Active Alerts</strong></p>
                    ${alerts.slice(0, 3).map(alert => `
                        <div class="alert alert-sm alert-${alert.priority === 'high' ? 'danger' : alert.priority === 'medium' ? 'warning' : 'info'} mb-2 p-2">
                            <small class="d-block">${alert.message}</small>
                            <small class="text-muted">${alert.type} ‚Ä¢ ${formatTime(alert.timestamp)}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="text-center text-success">
                    <h3>‚úì</h3>
                    <p><strong>No Active Alerts</strong></p>
                    <p class="text-sm">All systems operational</p>
                </div>
            `;
        }
    } else {
        container.innerHTML = `
            <div class="text-center text-warning">
                <p>‚ö†Ô∏è Alerts system</p>
                <small>Status: Monitoring</small>
            </div>
        `;
    }
}

// Display enhanced ETA calculation
function displayETAData(data) {
    const container = document.getElementById('etaData');
    
    if (data.status === 'success' && data.data) {
        const eta = data.data;
        container.innerHTML = `
            <div class="row text-center">
                <div class="col-md-3 mb-3">
                    <h4 class="text-info">${eta.base_eta_hours}h</h4>
                    <p><small>Base ETA</small></p>
                </div>
                <div class="col-md-3 mb-3">
                    <h4 class="text-primary">${eta.adjusted_eta_hours}h</h4>
                    <p><small>Adjusted ETA</small></p>
                </div>
                <div class="col-md-3 mb-3">
                    <h4 class="${eta.total_impact_percent > 0 ? 'text-warning' : 'text-success'}">${eta.total_impact_percent}%</h4>
                    <p><small>Total Impact</small></p>
                </div>
                <div class="col-md-3 mb-3">
                    <h4 class="text-dark">${Math.round(eta.confidence_score * 100)}%</h4>
                    <p><small>Confidence</small></p>
                </div>
            </div>
            <div class="mt-3 p-3 bg-light rounded">
                <div class="row text-sm">
                    <div class="col-4">
                        <small>Weather: ${eta.weather_impact_percent}%</small>
                    </div>
                    <div class="col-4">
                        <small>Current: ${eta.current_impact_percent}%</small>
                    </div>
                    <div class="col-4">
                        <small>Sea State: ${eta.sea_state_impact_percent}%</small>
                    </div>
                </div>
                <small class="text-muted d-block mt-2">Based on real marine navigation factors</small>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="text-center text-info">
                <p>ETA calculation in progress</p>
                <small>Processing real route data...</small>
            </div>
        `;
    }
}

// Helper function to format time
function formatTime(timestamp) {
    return new Date(timestamp).toLocaleTimeString();
}

// Error display functions
function displayWeatherError() {
    document.getElementById('weatherData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è Weather API</p>
            <small>Temporary issue with public service</small>
        </div>
    `;
}

function displayShipsError() {
    document.getElementById('shipsData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è AIS Data</p>
            <small>Public feed connection issue</small>
        </div>
    `;
}

function displayFuelError() {
    document.getElementById('fuelData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è Analytics</p>
            <small>Processing real data</small>
        </div>
    `;
}

function displayAlertsError() {
    document.getElementById('alertsData').innerHTML = `
        <div class="text-center text-warning">
            <p>‚ö†Ô∏è Monitoring</p>
            <small>System check in progress</small>
        </div>
    `;
}

function displayETAError() {
    document.getElementById('etaData').innerHTML = `
        <div class="text-center text-info">
            <p>ETA service</p>
            <small>Calculating real routes...</small>
        </div>
    `;
}

// Update status display
function updateStatus(message, type) {
    const alert = document.getElementById('statusAlert');
    const text = document.getElementById('statusText');
    
    alert.className = `alert alert-${type}`;
    text.textContent = message;
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Maritime Dashboard initializing with real data...");
    
    // Initialize map immediately
    initializeMaritimeMap();
    
    // Load real data
    loadRealData();
    
    // Refresh real data every 30 seconds
    setInterval(loadRealData, 30000);
});
</script>
{% endblock %}