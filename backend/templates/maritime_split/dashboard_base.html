{% extends "base.html" %}

{% block title %}Maritime Dashboard | BergNavn{% endblock %}

{% block head %}
<!-- Dashboard CSS -->
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header text-center">
    <h1 class="text-gradient">ðŸŒŠ Maritime Dashboard</h1>
    <p class="lead">Live AIS â€¢ MET Weather â€¢ RTZ Routes</p>
    
    <!-- Port Status -->
    <div class="mt-3 ports-badges-container">
        {% for port in ['Bergen', 'Oslo', 'Stavanger', 'Trondheim', 'Ã…lesund', 'Andalsnes', 'Drammen', 'Kristiansand', 'Sandefjord', 'Flekkefjord'] %}
            <span class="city-badge badge-{{ port|lower|replace('Ã¥', 'a') }}" 
                  data-port="{{ port|lower }}">
                {{ port }}
            </span>
        {% endfor %}
    </div>
</div>

<!-- Main Dashboard -->
<div class="container-fluid mt-4">
    
    <!-- Control Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-controls">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="status-indicator status-live"></span>
                        <span class="fw-semibold text-success" id="data-status">Live</span>
                        <span class="ms-3" id="local-time">--:--</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="control-btn" id="refresh-btn">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="control-btn" id="rtz-btn">
                            <i class="fas fa-route"></i>
                        </button>
                        <button class="control-btn" id="weather-btn">
                            <i class="bi bi-cloud-sun"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Norwegian Waters</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">
                            <i class="bi bi-ship me-1"></i>
                            <span id="vessel-count">0</span>
                        </span>
                        <span class="badge bg-success text-dark">
                            <i class="fas fa-route me-1"></i>
                            <span id="route-count">
                                {% if routes and routes|length > 0 %}
                                    {{ routes|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="maritime-map" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <!-- Weather -->
        <div class="col-md-3 mb-3">
            <div class="stats-card temp-stat">
                <h6><i class="bi bi-cloud-sun me-2"></i>Weather</h6>
                <h3 id="weather-temp">--Â°C</h3>
                <small class="text-muted" id="weather-location">Bergen</small>
            </div>
        </div>
        
        <!-- Wind -->
        <div class="col-md-3 mb-3">
            <div class="stats-card wind-stat">
                <h6><i class="bi bi-wind me-2"></i>Wind</h6>
                <h3 id="wind-speed">-- m/s</h3>
                <small class="text-muted">Coastal</small>
            </div>
        </div>
        
        <!-- Vessels -->
        <div class="col-md-3 mb-3">
            <div class="stats-card vessels-stat">
                <h6><i class="bi bi-ship me-2"></i>Vessels</h6>
                <h3 id="active-vessels">--</h3>
                <small class="text-muted">Norwegian Waters</small>
            </div>
        </div>
        
        <!-- RTZ Routes -->
        <div class="col-md-3 mb-3">
            <div class="stats-card rtz-stat">
                <h6><i class="fas fa-route me-2"></i>RTZ Routes</h6>
                <h3>
                    {% if routes and routes|length > 0 %}
                        {{ routes|length }}
                    {% else %}
                        0
                    {% endif %}
                </h3>
                <small class="text-muted">
                    {% if cities_with_routes and cities_with_routes|length > 0 %}
                        {{ cities_with_routes|length }}/10 ports
                    {% else %}
                        0/10 ports
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Routes Table -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-route me-2"></i>
                        NCA Maritime Routes
                    </h5>
                </div>
                <div class="card-body">
                    {% if routes and routes|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Route Name</th>
                                        <th>Origin</th>
                                        <th>Destination</th>
                                        <th>Distance</th>
                                        <th>Waypoints</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for route in routes %}
                                    <tr>
                                        <td>{{ route.name or 'NCA Route' }}</td>
                                        <td>{{ route.origin or 'Unknown' }}</td>
                                        <td>{{ route.destination or 'Unknown' }}</td>
                                        <td>{{ (route.total_distance_nm or 0)|round(1) }} NM</td>
                                        <td>{{ route.waypoint_count or 0 }}</td>
                                        <td>
                                            {% if route.source == 'NCA' %}
                                                <span class="badge bg-success">Database</span>
                                            {% else %}
                                                <span class="badge bg-info">RTZ File</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-route text-muted fs-1"></i>
                            <p class="mt-2 text-muted">No RTZ routes found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/split/maritime_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/maritime_weather.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/rtz_routes.js') }}"></script>

<script>
// Dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard initialized');
    
    // Update local time
    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { 
            timeZone: 'Europe/Oslo',
            hour: '2-digit', 
            minute: '2-digit' 
        });
        const dateStr = now.toLocaleDateString('en-GB', {
            timeZone: 'Europe/Oslo',
            weekday: 'short'
        });
        document.getElementById('local-time').textContent = dateStr + ' ' + timeStr;
    }
    
    updateTime();
    setInterval(updateTime, 60000);
    
    // Button handlers
    document.getElementById('refresh-btn').addEventListener('click', function() {
        location.reload();
    });
    
    document.getElementById('rtz-btn').addEventListener('click', function() {
        if (window.rtzManager) {
            window.rtzManager.toggle();
        }
    });
    
    // Port badges
    document.querySelectorAll('.city-badge').forEach(badge => {
        badge.style.cursor = 'pointer';
        badge.addEventListener('click', function() {
            const port = this.dataset.port;
            console.log('Port selected:', port);
        });
    });
});
</script>
{% endblock %}