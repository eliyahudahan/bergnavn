{% extends "base.html" %}

{% block title %}Maritime Dashboard | BergNavn{% endblock %}

{% block head %}
<!-- Dashboard CSS -->
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header text-center">
    <h1 class="text-gradient">ðŸŒŠ Maritime Dashboard</h1>
    <p class="lead">Live AIS â€¢ MET Weather â€¢ RTZ Routes</p>
    
    <!-- Port Status -->
    <div class="mt-3 ports-badges-container">
        {% for port in ['Bergen', 'Oslo', 'Stavanger', 'Trondheim', 'Ã…lesund', 'Andalsnes', 'Drammen', 'Kristiansand', 'Sandefjord', 'Flekkefjord'] %}
            <span class="city-badge badge-{{ port|lower|replace('Ã¥', 'a') }}" 
                  data-port="{{ port|lower }}">
                {{ port }}
            </span>
        {% endfor %}
    </div>
</div>

<!-- Main Dashboard -->
<div class="container-fluid mt-4">
    
    <!-- Control Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-controls">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="status-indicator status-live"></span>
                        <span class="fw-semibold text-success" id="data-status">Live</span>
                        <span class="ms-3" id="local-time">--:--</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="control-btn" id="refresh-btn">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="control-btn" id="rtz-btn">
                            <i class="fas fa-route"></i>
                        </button>
                        <button class="control-btn" id="weather-btn">
                            <i class="bi bi-cloud-sun"></i>
                        </button>
                        <button class="control-btn" id="ais-btn" title="Show real vessels">
                            <i class="bi bi-ship"></i>
                        </button>
                        <button class="control-btn" id="turbine-btn" title="Show wind turbines">
                            <i class="bi bi-fan"></i>
                        </button>
                        <button class="control-btn" id="tanker-btn" title="Show tankers">
                            <i class="bi bi-droplet"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Norwegian Waters</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">
                            <i class="bi bi-ship me-1"></i>
                            <span id="vessel-count">0</span>
                        </span>
                        <span class="badge bg-success text-dark">
                            <i class="fas fa-route me-1"></i>
                            <span id="route-count">
                                {% if routes and routes|length > 0 %}
                                    {{ routes|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </span>
                        <span class="badge bg-warning text-dark ms-2">
                            <i class="bi bi-wind me-1"></i>
                            <span id="turbine-count">0</span>
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="maritime-map" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <!-- Weather -->
        <div class="col-md-3 mb-3">
            <div class="stats-card temp-stat">
                <h6><i class="bi bi-cloud-sun me-2"></i>Weather</h6>
                <h3 id="weather-temp">--Â°C</h3>
                <small class="text-muted" id="weather-location">Bergen</small>
            </div>
        </div>
        
        <!-- Wind -->
        <div class="col-md-3 mb-3">
            <div class="stats-card wind-stat">
                <h6><i class="bi bi-wind me-2"></i>Wind</h6>
                <h3 id="wind-speed">-- m/s</h3>
                <small class="text-muted" id="wind-direction">--Â°</small>
            </div>
        </div>
        
        <!-- Vessels -->
        <div class="col-md-3 mb-3">
            <div class="stats-card vessels-stat">
                <h6><i class="bi bi-ship me-2"></i>Vessels</h6>
                <h3 id="active-vessels">--</h3>
                <small class="text-muted" id="vessel-type">Loading...</small>
            </div>
        </div>
        
        <!-- RTZ Routes -->
        <div class="col-md-3 mb-3">
            <div class="stats-card rtz-stat">
                <h6><i class="fas fa-route me-2"></i>RTZ Routes</h6>
                <h3 id="route-display-count">
                    {% if routes and routes|length > 0 %}
                        {{ routes|length }}
                    {% else %}
                        0
                    {% endif %}
                </h3>
                <small class="text-muted" id="route-coverage">
                    {% if cities_with_routes and cities_with_routes|length > 0 %}
                        {{ cities_with_routes|length }}/10 ports
                    {% else %}
                        0/10 ports
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Routes Table -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-route me-2"></i>
                        NCA Maritime Routes
                    </h5>
                </div>
                <div class="card-body">
                    {% if routes and routes|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Route Name</th>
                                        <th>Origin</th>
                                        <th>Destination</th>
                                        <th>Distance</th>
                                        <th>Waypoints</th>
                                        <th>Source</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for route in routes %}
                                    <tr>
                                        <td>
                                            {% if route.name %}
                                                {{ route.name }}
                                            {% elif route.description %}
                                                {{ route.description|truncate(50) }}
                                            {% else %}
                                                NCA Route {{ loop.index }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if route.origin and "Position" in route.origin %}
                                                {% set origin_name = convert_route_position(route.origin) %}
                                                {% if origin_name != route.origin %}
                                                    {{ origin_name }}
                                                    <br><small class="text-muted">{{ route.origin }}</small>
                                                {% else %}
                                                    {{ route.origin }}
                                                {% endif %}
                                            {% elif route.origin %}
                                                {{ route.origin }}
                                            {% else %}
                                                {% set origin_name = convert_route_position_by_coordinates(route.start_lat, route.start_lon) if route.start_lat and route.start_lon else 'Norwegian Coast' %}
                                                {{ origin_name }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if route.destination and "Position" in route.destination %}
                                                {% set dest_name = convert_route_position(route.destination) %}
                                                {% if dest_name != route.destination %}
                                                    {{ dest_name }}
                                                    <br><small class="text-muted">{{ route.destination }}</small>
                                                {% else %}
                                                    {{ route.destination }}
                                                {% endif %}
                                            {% elif route.destination %}
                                                {{ route.destination }}
                                            {% else %}
                                                {% set dest_name = convert_route_position_by_coordinates(route.end_lat, route.end_lon) if route.end_lat and route.end_lon else 'Norwegian Coast' %}
                                                {{ dest_name }}
                                            {% endif %}
                                        </td>
                                        <td>{{ (route.total_distance_nm or 0)|round(1) }} NM</td>
                                        <td>{{ route.waypoint_count or 'N/A' }}</td>
                                        <td>
                                            {% if route.source == 'NCA' %}
                                                <span class="badge bg-success">Database</span>
                                            {% elif route.source == 'RTZ File' %}
                                                <span class="badge bg-info">RTZ File</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Unknown</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-route text-muted fs-1"></i>
                            <p class="mt-2 text-muted">No RTZ routes found</p>
                            <a href="{{ url_for('routes_bp.scan_rtz_files') }}" 
                               class="btn btn-sm btn-outline-primary mt-2">
                                <i class="bi bi-search me-1"></i>Scan RTZ Files
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Data Status -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="alert alert-secondary small">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-activity me-1"></i>
                        <span id="data-update-time">Data updated: --:--</span>
                    </span>
                    <span>
                        <span class="badge bg-light text-dark me-2">
                            AIS: <span id="ais-status">Connecting...</span>
                        </span>
                        <span class="badge bg-light text-dark">
                            Weather: <span id="weather-status">Connected</span>
                        </span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/split/maritime_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/maritime_weather.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/rtz_routes.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/ais_realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/wind_turbines_realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/tanker_monitoring.js') }}"></script>

<script>
// Dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('BergNavn Maritime Dashboard initialized');
    
    // Wind turbine button handler
    document.getElementById('turbine-btn').addEventListener('click', function() {
        if (window.windTurbineManager) {
            window.windTurbineManager.showTurbines();
            this.classList.toggle('active');
        }
    });

    // Tanker button handler
    document.getElementById('tanker-btn').addEventListener('click', function() {
        if (window.tankerMonitor) {
            window.tankerMonitor.showTankers();
            this.classList.toggle('active');
            
            // Start monitoring if not already
            if (!window.tankerMonitor.updateInterval) {
                window.tankerMonitor.startMonitoring();
            }
        }
    });
    
    // Update local time and data timestamp
    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { 
            timeZone: 'Europe/Oslo',
            hour: '2-digit', 
            minute: '2-digit' 
        });
        const dateStr = now.toLocaleDateString('en-GB', {
            timeZone: 'Europe/Oslo',
            weekday: 'short',
            day: 'numeric',
            month: 'short'
        });
        
        // Update local time display
        document.getElementById('local-time').textContent = dateStr + ' ' + timeStr;
        
        // Update data timestamp
        document.getElementById('data-update-time').textContent = 
            `Data updated: ${dateStr} ${timeStr}`;
    }
    
    updateTime();
    setInterval(updateTime, 60000);
    
    // Button handlers
    document.getElementById('refresh-btn').addEventListener('click', function() {
        console.log('Manual refresh requested');
        location.reload();
    });
    
    document.getElementById('rtz-btn').addEventListener('click', function() {
        if (window.rtzManager) {
            window.rtzManager.toggle();
        }
    });
    
    document.getElementById('ais-btn').addEventListener('click', function() {
        if (window.aisManager && typeof window.aisManager.showRealtimeVessels === 'function') {
            window.aisManager.showRealtimeVessels();
            this.classList.toggle('active');
        } else {
            console.warn('AIS manager not available');
            alert('Real-time AIS data is currently loading...');
        }
    });
    
    // Port badges - show routes for selected port
    document.querySelectorAll('.city-badge').forEach(badge => {
        badge.style.cursor = 'pointer';
        badge.addEventListener('click', function() {
            const port = this.dataset.port;
            const portName = this.textContent.trim();
            console.log('Port selected:', port, portName);
            
            // Filter routes table for this port
            const rows = document.querySelectorAll('tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const originCell = row.cells[1];
                const destinationCell = row.cells[2];
                
                // Extract the main location name (before <br> if exists)
                let originText = originCell.textContent;
                if (originCell.querySelector('small')) {
                    originText = originCell.querySelector('small').previousSibling.textContent.trim();
                }
                
                let destinationText = destinationCell.textContent;
                if (destinationCell.querySelector('small')) {
                    destinationText = destinationCell.querySelector('small').previousSibling.textContent.trim();
                }
                
                const origin = originText.toLowerCase();
                const destination = destinationText.toLowerCase();
                
                if (origin.includes(port) || destination.includes(port)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update route count display
            document.getElementById('route-display-count').textContent = visibleCount;
            document.getElementById('route-coverage').textContent = 
                `${visibleCount} routes for ${portName}`;
        });
    });
    
    // Initialize AIS real-time data if available
    if (typeof window.aisManager !== 'undefined') {
        console.log('AIS manager found, starting real-time updates');
        setTimeout(() => {
            if (window.aisManager.startRealTimeUpdates) {
                window.aisManager.startRealTimeUpdates();
            }
        }, 2000);
    }
    
    // Show loading status
    setTimeout(() => {
        const aisStatus = document.getElementById('ais-status');
        if (aisStatus.textContent === 'Connecting...') {
            aisStatus.textContent = 'Connected';
            aisStatus.classList.add('text-success');
        }
    }, 3000);
    
    // Initialize turbine count from data if available
    if (window.windTurbineManager && window.windTurbineManager.turbines) {
        setTimeout(() => {
            const turbineCount = window.windTurbineManager.turbines.length || 0;
            document.getElementById('turbine-count').textContent = turbineCount;
        }, 1000);
    }
});
</script>
{% endblock %}