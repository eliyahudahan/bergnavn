{% extends "base.html" %}

{% block title %}Maritime Dashboard | BergNavn{% endblock %}

{% block head %}
<!-- Dashboard CSS -->
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header text-center">
    <h1 class="text-gradient">ðŸŒŠ Maritime Dashboard</h1>
    <p class="lead">Live AIS â€¢ MET Weather â€¢ RTZ Routes</p>
    
    <!-- Port Status -->
    <div class="mt-3 ports-badges-container">
        {% for port in ['Bergen', 'Oslo', 'Stavanger', 'Trondheim', 'Ã…lesund', 'Andalsnes', 'Drammen', 'Kristiansand', 'Sandefjord', 'Flekkefjord'] %}
            <span class="city-badge badge-{{ port|lower|replace('Ã¥', 'a') }}" 
                  data-port="{{ port|lower }}">
                {{ port }}
            </span>
        {% endfor %}
    </div>
</div>

<!-- Main Dashboard -->
<div class="container-fluid mt-4">
    
    <!-- Control Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-controls">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="status-indicator status-live"></span>
                        <span class="fw-semibold text-success" id="data-status">Live</span>
                        <span class="ms-3" id="local-time">--:--</span>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="control-btn" id="refresh-btn">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                        <button class="control-btn" id="rtz-btn">
                            <i class="fas fa-route"></i>
                        </button>
                        <button class="control-btn" id="weather-btn">
                            <i class="bi bi-cloud-sun"></i>
                        </button>
                        <button class="control-btn" id="ais-btn" title="Show real vessels">
                            <i class="bi bi-ship"></i>
                        </button>
                        <button class="control-btn" id="turbine-btn" title="Show wind turbines">
                            <i class="bi bi-fan"></i>
                        </button>
                        <button class="control-btn" id="tanker-btn" title="Show tankers">
                            <i class="bi bi-droplet"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Norwegian Waters</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">
                            <i class="bi bi-ship me-1"></i>
                            <span id="vessel-count">0</span>
                        </span>
                        <span class="badge bg-success text-dark">
                            <i class="fas fa-route me-1"></i>
                            <span id="route-count">
                                {% if routes and routes|length > 0 %}
                                    {{ routes|length }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </span>
                        <span class="badge bg-warning text-dark ms-2">
                            <i class="bi bi-wind me-1"></i>
                            <span id="turbine-count">0</span>
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="maritime-map" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <!-- Weather -->
        <div class="col-md-3 mb-3">
            <div class="stats-card temp-stat">
                <h6><i class="bi bi-cloud-sun me-2"></i>Weather</h6>
                <h3 id="weather-temp">--Â°C</h3>
                <small class="text-muted" id="weather-location">Bergen</small>
            </div>
        </div>
        
        <!-- Wind -->
        <div class="col-md-3 mb-3">
            <div class="stats-card wind-stat">
                <h6><i class="bi bi-wind me-2"></i>Wind</h6>
                <h3 id="wind-speed">-- m/s</h3>
                <small class="text-muted" id="wind-direction">--Â°</small>
            </div>
        </div>
        
        <!-- Vessels -->
        <div class="col-md-3 mb-3">
            <div class="stats-card vessels-stat">
                <h6><i class="bi bi-ship me-2"></i>Vessels</h6>
                <h3 id="active-vessels">--</h3>
                <small class="text-muted" id="vessel-type">Loading...</small>
            </div>
        </div>
        
        <!-- RTZ Routes -->
        <div class="col-md-3 mb-3">
            <div class="stats-card rtz-stat">
                <h6><i class="fas fa-route me-2"></i>RTZ Routes</h6>
                <h3 id="route-display-count">
                    {% if routes and routes|length > 0 %}
                        {{ routes|length }}
                    {% else %}
                        0
                    {% endif %}
                </h3>
                <small class="text-muted" id="route-coverage">
                    {% if cities_with_routes and cities_with_routes|length > 0 %}
                        {{ cities_with_routes|length }}/10 ports
                    {% else %}
                        0/10 ports
                    {% endif %}
                </small>
            </div>
        </div>
    </div>

    <!-- Routes Table -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-route me-2"></i>
                        NCA Maritime Routes
                    </h5>
                </div>
                <div class="card-body">
                    {% if routes and routes|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Route Name</th>
                                        <th>Origin</th>
                                        <th>Destination</th>
                                        <th>Distance (NM)</th>
                                        <th>Waypoints</th>
                                        <th>Source</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for route in routes %}
                                    <tr>
                                        <!-- Route Name -->
                                        <td>
                                            {% if route.display_name %}
                                                {{ route.display_name }}
                                            {% elif route.name %}
                                                {% set clean_name = route.name|replace('NCA_', '')|replace('_20250801', '')|replace('_20250731', '')|replace('_', ' ')|title %}
                                                {{ clean_name }}
                                            {% else %}
                                                NCA Route {{ loop.index }}
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Origin -->
                                        <td>
                                            {% if route.origin %}
                                                {{ route.origin }}
                                            {% elif route.start_lat and route.start_lon %}
                                                Position {{ "%.2f"|format(route.start_lat) }}, {{ "%.2f"|format(route.start_lon) }}
                                            {% else %}
                                                Norwegian Coast
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Destination -->
                                        <td>
                                            {% if route.destination %}
                                                {{ route.destination }}
                                            {% elif route.end_lat and route.end_lon %}
                                                Position {{ "%.2f"|format(route.end_lat) }}, {{ "%.2f"|format(route.end_lon) }}
                                            {% else %}
                                                Norwegian Coast
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Distance -->
                                        <td>
                                            {% if route.total_distance_nm %}
                                                {{ "%.1f"|format(route.total_distance_nm) }}
                                            {% else %}
                                                0.0
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Waypoints - FIXED -->
                                        <td>
                                            {% if route.waypoint_count and route.waypoint_count > 0 %}
                                                {{ route.waypoint_count }} points
                                            {% elif route.waypoints and route.waypoints > 0 %}
                                                {{ route.waypoints }} points
                                            {% else %}
                                                <!-- Fallback to name-based detection -->
                                                {% set route_name = (route.name or '')|lower %}
                                                {% if '18 waypoints' in route_name %}18 points
                                                {% elif '59 waypoints' in route_name %}59 points
                                                {% elif '23 waypoints' in route_name %}23 points
                                                {% elif '17 waypoints' in route_name %}17 points
                                                {% elif '14 waypoints' in route_name %}14 points
                                                {% elif '10 waypoints' in route_name %}10 points
                                                {% elif '7 waypoints' in route_name %}7 points
                                                {% elif '6 waypoints' in route_name %}6 points
                                                {% elif '5 waypoints' in route_name %}5 points
                                                {% else %}
                                                0 points
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Source -->
                                        <td>
                                            {% if route.source == 'database' or route.source == 'NCA' %}
                                                <i class="bi bi-shield-check me-1 text-success"></i> Kystverket RTZ
                                            {% elif route.source == 'RTZ File' %}
                                                <i class="bi bi-file-earmark-arrow-up me-1 text-info"></i> RTZ File
                                            {% else %}
                                                <i class="bi bi-database me-1 text-secondary"></i> Database
                                            {% endif %}
                                        </td>
                                        
                                        <!-- Status -->
                                        <td>
                                            {% if route.is_active or route.source == 'database' or route.source == 'NCA' %}
                                                <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>
                                            {% elif route.source == 'RTZ File' %}
                                                <span class="badge bg-warning"><i class="bi bi-hdd me-1"></i>File System</span>
                                            {% else %}
                                                <span class="badge bg-secondary"><i class="bi bi-question-circle me-1"></i>Unknown</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <!-- No routes message -->
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-route text-muted fs-1"></i>
                            </div>
                            <h5 class="text-muted">No RTZ Routes Found</h5>
                            <p class="text-muted mb-3">
                                No RTZ route data is currently available in the database or file system.
                            </p>
                            <div class="alert alert-warning text-start">
                                <small>
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Action Required:</strong> To load route data:
                                    <ul class="mb-0 mt-2">
                                        <li>Verify RTZ files exist in <code>backend/assets/routeinfo_routes/</code></li>
                                        <li>Run database migration: <code>flask db upgrade</code></li>
                                        <li>Click "Scan RTZ Files" below to import routes</li>
                                    </ul>
                                </small>
                            </div>
                            <a href="{{ url_for('routes_bp.scan_rtz_files') }}" 
                               class="btn btn-outline-primary mt-3">
                                <i class="bi bi-search me-1"></i>Scan RTZ Files
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Data Status -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="alert alert-secondary">
                <div class="d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-activity me-1"></i>
                        <span id="data-update-time">Data updated: --:--</span>
                    </span>
                    <span>
                        <span class="badge bg-light text-dark me-2">
                            <i class="bi bi-ship me-1"></i>
                            AIS: <span id="ais-status">Connecting...</span>
                        </span>
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-cloud-sun me-1"></i>
                            Weather: <span id="weather-status">Connected</span>
                        </span>
                        <span class="badge bg-light text-dark ms-2">
                            <i class="bi bi-database me-1"></i>
                            Routes: <span id="route-status" data-route-count="{{ routes|length if routes else 0 }}">{{ routes|length if routes else 0 }} active</span>
                        </span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet MarkerCluster -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/split/maritime_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/maritime_weather.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/rtz_routes.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/ais_realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/wind_turbines_realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/tanker_monitoring.js') }}"></script>

<script>
// Dashboard initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('BergNavn Maritime Dashboard initialized');
    
    // Get route count from data attribute (FIX for JavaScript-Jinja conflict)
    function getRouteCount() {
        const routeStatusElement = document.getElementById('route-status');
        if (routeStatusElement && routeStatusElement.dataset.routeCount) {
            return parseInt(routeStatusElement.dataset.routeCount) || 0;
        }
        return 0;
    }
    
    // Initialize real-time AIS data
    function initializeAIS() {
        if (typeof window.aisManager !== 'undefined') {
            console.log('AIS manager available, starting real-time updates');
            
            setTimeout(() => {
                if (window.aisManager.startRealTimeUpdates) {
                    window.aisManager.startRealTimeUpdates();
                    console.log('AIS real-time updates started');
                    
                    // Update status
                    const aisStatus = document.getElementById('ais-status');
                    if (aisStatus) {
                        aisStatus.textContent = 'Connected';
                        aisStatus.classList.add('text-success');
                    }
                }
            }, 2000);
        } else {
            console.warn('AIS manager not available, using empirical data');
            const aisStatus = document.getElementById('ais-status');
            if (aisStatus) {
                aisStatus.textContent = 'Empirical Data';
                aisStatus.classList.add('text-info');
            }
        }
    }
    
    // Wind turbine button handler
    document.getElementById('turbine-btn').addEventListener('click', function() {
        if (window.windTurbineManager) {
            window.windTurbineManager.showTurbines();
            this.classList.toggle('active');
            console.log('Wind turbines toggled');
        }
    });

    // Tanker button handler
    document.getElementById('tanker-btn').addEventListener('click', function() {
        if (window.tankerMonitor) {
            window.tankerMonitor.showTankers();
            this.classList.toggle('active');
            
            // Start monitoring if not already
            if (!window.tankerMonitor.updateInterval) {
                window.tankerMonitor.startMonitoring();
                console.log('Tanker monitoring started');
            }
        }
    });
    
    // Update local time and data timestamp
    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB', { 
            timeZone: 'Europe/Oslo',
            hour: '2-digit', 
            minute: '2-digit' 
        });
        const dateStr = now.toLocaleDateString('en-GB', {
            timeZone: 'Europe/Oslo',
            weekday: 'short',
            day: 'numeric',
            month: 'short'
        });
        
        // Update local time display
        const localTimeElement = document.getElementById('local-time');
        if (localTimeElement) {
            localTimeElement.textContent = dateStr + ' ' + timeStr;
        }
        
        // Update data timestamp
        const updateTimeElement = document.getElementById('data-update-time');
        if (updateTimeElement) {
            updateTimeElement.textContent = `Data updated: ${dateStr} ${timeStr}`;
        }
    }
    
    // Initial time update and set interval
    updateTime();
    setInterval(updateTime, 60000);
    
    // Button handlers
    document.getElementById('refresh-btn').addEventListener('click', function() {
        console.log('Manual refresh requested by user');
        location.reload();
    });
    
    document.getElementById('rtz-btn').addEventListener('click', function() {
        if (window.rtzManager) {
            window.rtzManager.toggle();
            console.log('RTZ routes toggled');
        }
    });
    
    document.getElementById('ais-btn').addEventListener('click', function() {
        if (window.aisManager && typeof window.aisManager.showRealtimeVessels === 'function') {
            window.aisManager.showRealtimeVessels();
            this.classList.toggle('active');
            console.log('Real-time AIS vessels toggled');
        } else {
            console.warn('AIS manager showRealtimeVessels function not available');
            alert('Real-time AIS data is currently loading. Please try again in a few seconds.');
        }
    });
    
    // Port badges - filter routes for selected port
    document.querySelectorAll('.city-badge').forEach(badge => {
        badge.style.cursor = 'pointer';
        badge.addEventListener('click', function() {
            const port = this.dataset.port;
            const portName = this.textContent.trim();
            console.log(`Port filter applied: ${portName} (${port})`);
            
            // Filter routes table for this port
            const rows = document.querySelectorAll('tbody tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const originCell = row.cells[1];
                const destinationCell = row.cells[2];
                
                // Use direct text content
                const originText = originCell.textContent.toLowerCase();
                const destinationText = destinationCell.textContent.toLowerCase();
                
                if (originText.includes(port) || destinationText.includes(port)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Update route count display
            const displayCountElement = document.getElementById('route-display-count');
            const coverageElement = document.getElementById('route-coverage');
            
            if (displayCountElement) {
                displayCountElement.textContent = visibleCount;
            }
            if (coverageElement) {
                coverageElement.textContent = `${visibleCount} routes for ${portName}`;
            }
            
            console.log(`Filter result: ${visibleCount} routes match ${portName}`);
        });
    });
    
    // Initialize systems
    initializeAIS();
    
    // Initialize turbine count from data if available
    if (window.windTurbineManager && window.windTurbineManager.turbines) {
        setTimeout(() => {
            const turbineCount = window.windTurbineManager.turbines.length || 0;
            const turbineCountElement = document.getElementById('turbine-count');
            if (turbineCountElement) {
                turbineCountElement.textContent = turbineCount;
            }
            console.log(`Wind turbine count: ${turbineCount}`);
        }, 1000);
    }
    
    // Log route count for debugging
    const routeCount = getRouteCount();
    console.log(`Dashboard loaded with ${routeCount} routes`);
});
</script>
{% endblock %}