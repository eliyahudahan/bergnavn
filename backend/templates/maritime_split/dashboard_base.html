<!-- backend/templates/maritime_split/dashboard_base.html -->
<!-- REAL-TIME MARITIME DASHBOARD v4.0 - COMPLETE FIX -->
{% extends "base.html" %}

{% block title %}Maritime Dashboard | BergNavn{% endblock %}

{% block head %}
<!-- Core CSS files -->
<link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/split/map.css') }}" rel="stylesheet">

<!-- External libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

<!-- Critical inline styles -->
<style>
/* Ensure proper display of route counts */
.city-badge .port-count {
    background: rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 0.7rem;
    padding: 1px 5px;
    border-radius: 10px;
    margin-left: 4px;
}

/* Route table interactivity */
.route-row-highlighted {
    background-color: rgba(52, 152, 219, 0.15) !important;
    border-left: 3px solid #3498db !important;
}

.route-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.route-row:hover:not(.route-row-highlighted) {
    background-color: rgba(52, 152, 219, 0.05) !important;
}

.city-badge.active {
    background-color: #3498db !important;
    color: white !important;
}

/* Empirical data indicator */
.data-source-empirical {
    background-color: #17a2b8 !important;
    color: white !important;
    font-size: 0.7rem !important;
    padding: 2px 6px !important;
    border-radius: 4px !important;
    margin-left: 4px;
}

/* Weather accuracy note */
.weather-accuracy-note {
    font-size: 0.7rem;
    opacity: 0.8;
    margin-top: 5px;
    padding: 3px 6px;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
    border-left: 3px solid #17a2b8;
}
</style>
{% endblock %}

{% block content %}
<!-- Hidden data container -->
<div id="routes-data" style="display: none;">
    {% if routes %}
        {{ routes|tojson|safe }}
    {% else %}
        []
    {% endif %}
</div>

<!-- Hidden waypoints data -->
<div id="waypoints-data" style="display: none;">
    {% if waypoints_data %}
        {{ waypoints_data|tojson|safe }}
    {% else %}
        {}
    {% endif %}
</div>

<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2"><i class="fas fa-ship me-2"></i>Maritime Dashboard</h1>
                <p class="mb-1">Real-time vessel tracking & RTZ route management</p>
                <div class="d-flex align-items-center mt-2">
                    <span class="status-indicator status-live"></span>
                    <span class="fw-semibold text-success me-3">LIVE</span>
                    <span id="local-time-norway" class="local-time-norway">--:--:--</span>
                    <span class="text-white-50 ms-2" id="norwegian-date">-- --- ----</span>
                </div>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="mt-2">
                    <span class="badge bg-primary me-2">
                        <i class="fas fa-database me-1"></i>
                        <span id="route-count-badge">{{ routes|length if routes else 0 }}</span> RTZ Routes
                    </span>
                    <span class="badge bg-success me-2">
                        <i class="fas fa-ship me-1"></i>
                        <span id="vessel-count">0</span> Vessels
                        <span id="real-time-vessel-counter" class="fallback-mode">LOADING</span>
                    </span>
                    <span class="badge bg-warning" id="weather-status-badge">
                        <i class="fas fa-wind me-1"></i>
                        <span id="weather-status-text">Loading...</span>
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Ports filter -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex flex-wrap align-items-center">
                    <span class="me-2 text-white-80">Filter ports:</span>
                    {% if ports_list and ports_list|length > 0 %}
                        {% for port in ports_list %}
                        {% set port_normalized = port|lower|replace('√•', 'a')|replace('√Ö', 'a') %}
                        <span class="city-badge" data-port="{{ port_normalized }}">
                            {{ port }}
                            <span class="badge bg-secondary bg-opacity-50 ms-1 port-count">
                                {{ port_counts.get(port, 0) if port_counts else 0 }}
                            </span>
                        </span>
                        {% endfor %}
                    {% else %}
                        {% set default_ports = ['Bergen', 'Oslo', 'Stavanger', 'Trondheim', '√Ölesund', '√Öndalsnes', 'Kristiansand', 'Drammen', 'Sandefjord', 'Flekkefjord'] %}
                        {% for port in default_ports %}
                        {% set port_normalized = port|lower|replace('√•', 'a')|replace('√Ö', 'a') %}
                        <span class="city-badge" data-port="{{ port_normalized }}">
                            {{ port }}
                            <span class="badge bg-secondary bg-opacity-50 ms-1 port-count">0</span>
                        </span>
                        {% endfor %}
                    {% endif %}
                    <span class="city-badge ms-2" id="reset-filters" data-port="reset">
                        <i class="fas fa-times me-1"></i> Clear
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Data quality indicator -->
        <div class="row mt-2">
            <div class="col-12">
                <div class="d-flex align-items-center">
                    <small class="text-white-80 me-2">Data sources:</small>
                    <span class="data-quality-indicator data-quality-high me-2">
                        <i class="fas fa-check-circle me-1"></i>
                        RTZ: Verified
                    </span>
                    <span class="data-quality-indicator data-quality-medium me-2" id="ais-data-quality">
                        <i class="fas fa-ship me-1"></i>
                        AIS: Loading...
                    </span>
                    <span class="data-quality-indicator data-quality-high" id="weather-data-quality">
                        <i class="fas fa-wind me-1"></i>
                        Weather: MET Norway
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard -->
<div class="container-fluid mt-4">
    <!-- Control Bar -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-semibold text-muted">API Status:</span>
                    <span class="api-status api-status-partial ms-2" id="api-overall-status">
                        <i class="fas fa-satellite-dish me-1"></i>
                        Initializing...
                    </span>
                    <small class="text-muted ms-3" id="api-details">
                        RTZ: ‚úì | AIS: Loading... | Weather: ‚úì
                    </small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="control-btn" id="refresh-btn" title="Refresh all data">
                        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                    </button>
                    <button class="control-btn active" id="rtz-toggle-btn" title="Toggle RTZ Routes">
                        <i class="fas fa-route me-1"></i> Routes
                    </button>
                    <button class="control-btn active" id="weather-toggle-btn" title="Toggle Weather">
                        <i class="bi bi-cloud-sun me-1"></i> Weather
                    </button>
                    <button class="control-btn active" id="ais-toggle-btn" title="Toggle AIS">
                        <i class="bi bi-ship me-1"></i> AIS
                    </button>
                    <button class="control-btn" id="debug-toggle-btn" title="Debug Information">
                        <i class="bi bi-bug me-1"></i> Debug
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Map and Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-geo-alt me-2"></i>
                        Norwegian Waters - Live Maritime Overview
                        <small class="text-muted ms-2" id="map-update-time">Updated: --:--</small>
                    </h5>
                    <div>
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="auto-refresh-toggle" checked>
                            <label class="form-check-label" for="auto-refresh-toggle">Auto-refresh</label>
                        </div>
                        <button class="btn btn-sm btn-outline-primary" id="show-rtz-panel">
                            <i class="fas fa-list me-1"></i> Routes List
                        </button>
                    </div>
                </div>
                <div class="card-body p-0 position-relative">
                    <div id="maritime-map"></div>
                    
                    <!-- Loading overlay -->
                    <div id="map-loading-overlay" class="loading-overlay" style="display: none;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 mb-0 text-muted" id="map-loading-text">Loading map data...</p>
                        </div>
                    </div>
                    
                    <!-- Data source legend -->
                    <div class="map-legend">
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #28a745;"></span>
                            <span class="legend-label">RTZ Route Start</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #dc3545;"></span>
                            <span class="legend-label">RTZ Route End</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #007bff;"></span>
                            <span class="legend-label">Route Waypoint</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: #ffc107;"></span>
                            <span class="legend-label" id="vessel-legend-text">Vessels (Live)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <!-- Weather -->
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <h6>
                    <i class="bi bi-cloud-sun me-2 weather-icon" id="weather-main-icon"></i>
                    Current Weather
                    <span id="weather-source-indicator" class="data-source-badge data-source-live">MET</span>
                </h6>
                <h2 id="weather-temp" class="fw-bold">--¬∞C</h2>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <small class="text-muted d-block" id="weather-location">Bergen, Norway</small>
                        <small class="text-muted" id="weather-condition">Loading...</small>
                        <small class="weather-accuracy-note" id="weather-accuracy">
                            <i class="fas fa-info-circle me-1"></i>
                            Official MET Norway data
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="fw-semibold" id="weather-wind">-- m/s</div>
                        <small class="text-muted">Wind</small>
                    </div>
                </div>
                <small class="data-freshness" id="weather-updated">Updating...</small>
            </div>
        </div>
        
        <!-- Vessels -->
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <h6>
                    <i class="bi bi-ship me-2"></i>
                    Active Vessels
                    <span id="vessel-source-indicator" class="data-source-badge data-source-empirical">
                        EMPIRICAL
                    </span>
                </h6>
                <h2 id="active-vessels" class="fw-bold">--</h2>
                <div class="mb-2">
                    <small class="text-muted d-block" id="vessel-type">
                        <i class="fas fa-info-circle me-1"></i>
                        Based on active AIS signals
                    </small>
                    <small class="text-muted" id="vessel-range">Within 50km radius of center</small>
                </div>
                <small class="data-freshness" id="vessels-updated">Updating...</small>
            </div>
        </div>
        
        <!-- RTZ Routes -->
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <h6><i class="fas fa-route me-2"></i>RTZ Routes</h6>
                <h2 id="route-count" class="fw-bold">{{ routes|length if routes else 0 }}</h2>
                <div class="mb-2">
                    <small class="text-muted d-block">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        <span id="waypoint-count">--</span> waypoints
                    </small>
                    <small class="text-muted">
                        <i class="fas fa-anchor me-1"></i>
                        {{ unique_ports_count if unique_ports_count else ports_list|length if ports_list else 0 }} ports
                    </small>
                </div>
                <small class="data-freshness live" id="routes-updated">Live Database</small>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="col-md-3 mb-3">
            <div class="stats-card">
                <h6><i class="fas fa-server me-2"></i>System Status</h6>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>RTZ Routes</small>
                        {% if routes and routes|length > 0 %}
                            <span class="badge bg-success">‚úì Live ({{ routes|length }})</span>
                        {% else %}
                            <span class="badge bg-danger">‚úó Offline</span>
                        {% endif %}
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <small>Weather API</small>
                        <span class="badge bg-warning" id="weather-api-status">‚è≥ Loading</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <small>AIS API</small>
                        <span class="badge bg-warning" id="ais-api-status">‚è≥ Loading</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <small>Data Quality</small>
                        {% if routes and routes|length >= 30 %}
                            <span class="badge bg-success">Excellent</span>
                        {% elif routes and routes|length >= 10 %}
                            <span class="badge bg-info">Good</span>
                        {% else %}
                            <span class="badge bg-warning" id="data-quality-status">Limited</span>
                        {% endif %}
                    </div>
                </div>
                <small class="text-muted" id="system-update-time">Last check: --:--</small>
            </div>
        </div>
    </div>

    <!-- Routes Table -->
    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-route me-2"></i>
                        RTZ Routes Database
                        <span class="badge bg-primary ms-2">{{ routes|length if routes else 0 }}</span>
                        <small class="text-muted ms-3" id="routes-data-source">
                            <i class="fas fa-database me-1"></i>
                            Norwegian Coastal Administration (Verified)
                        </small>
                    </h5>
                </div>
                <div class="card-body">
                    {% if routes and routes|length > 0 %}
                        <div class="alert alert-info mb-3">
                            <div class="d-flex">
                                <i class="fas fa-info-circle me-2 mt-1"></i>
                                <div>
                                    <small class="fw-semibold">Real RTZ Data Available</small>
                                    <br>
                                    <small>Showing <strong>{{ routes|length }}</strong> professionally surveyed routes from NCA. Click any route to highlight it on the map.</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="route-table-container">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Route Name</th>
                                        <th>Origin ‚Üí Destination</th>
                                        <th>Distance</th>
                                        <th>Waypoints</th>
                                        <th>Port</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="routes-table-body">
                                    {% for route in routes %}
                                    {% set city_name = route.source_city if route.source_city else route.source_city_name if route.source_city_name else '' %}
                                    {% if city_name == "Alesund" %}{% set city_name = "√Ölesund" %}{% endif %}
                                    {% if city_name == "Andalsnes" %}{% set city_name = "√Öndalsnes" %}{% endif %}
                                    
                                    <tr class="route-row" data-route-id="{{ route.route_id or loop.index }}" data-city="{{ city_name|lower if city_name else '' }}">
                                        <td class="text-muted fw-semibold">{{ loop.index }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="route-status-dot route-status-verified"></span>
                                                <strong class="route-name-display">
                                                    {% if route.clean_name %}
                                                        {{ route.clean_name }}
                                                    {% elif route.route_name %}
                                                        {{ route.route_name|replace('NCA_', '')|replace('_2025', '')|replace('_', ' ')|title }}
                                                    {% else %}
                                                        Route {{ loop.index }}
                                                    {% endif %}
                                                </strong>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-success bg-opacity-25 me-1 px-2 py-1">
                                                    {% if route.origin and route.origin != 'Unknown' %}
                                                        {{ route.origin }}
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </span>
                                                <i class="fas fa-arrow-right mx-1 text-muted small"></i>
                                                <span class="badge bg-danger bg-opacity-25 ms-1 px-2 py-1">
                                                    {% if route.destination and route.destination != 'Unknown' %}
                                                        {{ route.destination }}
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            {% if route.total_distance_nm %}
                                                <span class="fw-bold">{{ "%.1f"|format(route.total_distance_nm) }}</span>
                                                <small class="text-muted">NM</small>
                                            {% else %}
                                                <span class="text-muted">--</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if route.waypoint_count %}
                                                <span class="badge bg-info bg-opacity-25 px-2 py-1">{{ route.waypoint_count }}</span>
                                            {% else %}
                                                <span class="text-muted">--</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if city_name %}
                                                <span class="badge bg-primary bg-opacity-25 px-2 py-1">{{ city_name|title }}</span>
                                            {% else %}
                                                <span class="text-muted">--</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-success bg-opacity-75">Verified</span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary view-route-btn" 
                                                        data-route-id="{{ route.route_id or loop.index }}" 
                                                        data-has-waypoints="{{ 'true' if route.waypoint_count and route.waypoint_count > 0 else 'false' }}"
                                                        title="Zoom to route on map">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-info highlight-route-btn" 
                                                        data-route-id="{{ route.route_id or loop.index }}"
                                                        title="Highlight route">
                                                    <i class="fas fa-map-marker-alt"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary route-info-btn" 
                                                        data-route-id="{{ route.route_id or loop.index }}"
                                                        title="Show route details">
                                                    <i class="fas fa-info"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 pt-3 border-top">
                            <div class="row">
                                <div class="col-md-4">
                                    <small class="text-muted">
                                        <i class="bi bi-list-check me-1"></i>
                                        Total routes: <strong>{{ routes|length }}</strong>
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">
                                        <i class="bi bi-geo-alt me-1"></i>
                                        Active ports: <strong id="active-ports-display">
                                            {% if unique_ports_count is defined %}
                                                {{ unique_ports_count }}
                                            {% else %}
                                                {{ ports_list|length if ports_list else 0 }}
                                            {% endif %}
                                        </strong>
                                    </small>
                                </div>
                                <div class="col-md-4">
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>
                                        Data updated: <span id="route-update-time" class="fw-semibold">Just now</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- Fallback - should NOT appear if maritime_routes.py works -->
                        <div class="text-center py-5">
                            <div class="mb-3">
                                <i class="fas fa-exclamation-triangle text-warning fs-1"></i>
                            </div>
                            <h5 class="text-warning">‚ö†Ô∏è Route Data Temporarily Unavailable</h5>
                            <p class="text-muted mb-3">
                                The system is loading 50+ NCA RTZ routes. This may take a moment.
                            </p>
                            <div class="d-flex justify-content-center gap-3">
                                <button class="btn btn-outline-primary" onclick="window.location.reload()">
                                    <i class="fas fa-sync-alt me-1"></i> Reload Dashboard
                                </button>
                                <a href="/maritime/api/rtz-status" target="_blank" class="btn btn-outline-info">
                                    <i class="fas fa-code me-1"></i> Check API Status
                                </a>
                            </div>
                            <div class="mt-4 small text-muted">
                                <p>If this persists, ensure you're accessing: <code>/maritime/dashboard</code></p>
                                <p>Current URL: <span id="current-url">{{ request.url }}</span></p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="dashboard-notification" class="dashboard-notification">
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="notification-title">Notification</strong>
            <small id="notification-time">Just now</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="notification-message">
            Message content here.
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}
<!-- Maritime Dashboard Footer - SIMPLE AND CLEAN -->
<footer class="maritime-dashboard-footer">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4 mb-md-0">
                <h6 class="footer-heading">
                    <i class="fas fa-water me-2"></i>BergNavn Maritime
                </h6>
                <p class="footer-text mb-2">Intelligent Route Optimization System</p>
                <div class="port-list mb-2">
                    <strong class="footer-subheading">Norwegian Ports:</strong><br>
                    √Ölesund, Andalsnes, Bergen, Drammen, Flekkefjord<br>
                    Kristiansand, Oslo, Sandefjord, Stavanger, Trondheim
                </div>
                <p class="footer-tech small">
                    <i class="fas fa-code me-1"></i>
                    Flask ‚Ä¢ PostgreSQL ‚Ä¢ BarentsWatch API ‚Ä¢ MET Norway
                </p>
            </div>
            
            <div class="col-md-4 mb-4 mb-md-0">
                <h6 class="footer-heading">
                    <i class="fas fa-server me-2"></i>System Status
                </h6>
                <div class="system-status">
                    <p class="footer-text mb-2">
                        <span class="status-indicator status-operational me-2"></span>
                        <span id="footer-system-status">
                            {% if routes and routes|length > 0 %}
                                {{ routes|length }} NCA Routes Active
                            {% else %}
                                All Systems Operational
                            {% endif %}
                        </span>
                    </p>
                    <p class="footer-text small mb-2">
                        <i class="far fa-clock me-1"></i>
                        Data updated: <span id="footer-update-time">{{ now().strftime('%d %b %H:%M') if now else '--:--' }}</span>
                    </p>
                    <p class="footer-text small">
                        <i class="fas fa-plug me-1"></i>
                        API Status: <span id="footer-api-status" class="status-active">Active</span>
                    </p>
                </div>
            </div>
            
            <div class="col-md-4">
                <h6 class="footer-heading">
                    <i class="fas fa-info-circle me-2"></i>Information
                </h6>
                <div class="footer-links mb-3">
                    <a href="/about" class="footer-link d-block mb-1">About</a>
                    <a href="/contact" class="footer-link d-block mb-1">Contact</a>
                    <a href="/legal" class="footer-link d-block">Legal</a>
                </div>
                <div class="copyright">
                    <p class="copyright-text mb-1">¬© 2025 BergNavn Maritime | Research & Development Platform</p>
                    <p class="copyright-source small">
                        <i class="fas fa-database me-1"></i>
                        Data sources: BarentsWatch AIS ‚Ä¢ MET Norway ‚Ä¢ Norwegian Coastal Administration
                    </p>
                </div>
            </div>
        </div>
    </div>
</footer>
{% endblock %}

{% block scripts %}
<!-- External libraries -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Dashboard JavaScript modules -->
<script src="{{ url_for('static', filename='js/split/maritime_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/maritime_weather.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/ais_realtime.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/dashboard_controls.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/rtz_waypoints.js') }}"></script>

<!-- Main dashboard initialization -->
<script>
// Global data storage
window.dashboardData = {
    routes: [],
    waypoints: {},
    map: null
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('üö¢ Dashboard v4.0 - Initializing');
    
    // Load routes data
    try {
        const routesDataElement = document.getElementById('routes-data');
        if (routesDataElement && routesDataElement.textContent) {
            window.dashboardData.routes = JSON.parse(routesDataElement.textContent);
            console.log(`üìä Loaded ${window.dashboardData.routes.length} routes`);
        }
    } catch (e) {
        console.error('Error loading routes:', e);
    }
    
    // Initialize time
    updateNorwegianTime();
    setInterval(updateNorwegianTime, 1000);
    
    // Initialize route buttons - FIXED VERSION
    initRouteButtons();
    
    // Initialize footer with live data
    updateFooterStatus();
});

function updateNorwegianTime() {
    const now = new Date();
    const timeElement = document.getElementById('local-time-norway');
    const dateElement = document.getElementById('norwegian-date');
    const footerTime = document.getElementById('footer-update-time');
    
    if (timeElement) {
        timeElement.textContent = now.toLocaleTimeString('en-GB', { 
            timeZone: 'Europe/Oslo', 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit', 
            hour12: false 
        });
    }
    
    if (dateElement) {
        dateElement.textContent = now.toLocaleDateString('en-GB', { 
            timeZone: 'Europe/Oslo',
            weekday: 'short',
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
    }
    
    if (footerTime) {
        footerTime.textContent = now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit',
            timeZone: 'Europe/Oslo' 
        });
    }
}

function initRouteButtons() {
    // Handle view route button clicks - FIXED: Use row index instead of route ID
    document.addEventListener('click', function(e) {
        if (e.target.closest('.view-route-btn')) {
            const button = e.target.closest('.view-route-btn');
            
            console.log('üîç View route button clicked');
            
            // Get the table row
            const row = button.closest('tr');
            if (!row) {
                console.error('‚ùå Could not find table row');
                showNotification('Could not find route row', 'error');
                return;
            }
            
            // Get all data rows (skip header if it exists)
            const tbody = row.closest('tbody');
            if (!tbody) {
                console.error('‚ùå Could not find table body');
                showNotification('Could not find routes table', 'error');
                return;
            }
            
            const allRows = Array.from(tbody.querySelectorAll('tr'));
            const routeIndex = allRows.indexOf(row);
            
            console.log(`üìä Found route at row index: ${routeIndex} (total rows: ${allRows.length})`);
            
            if (routeIndex >= 0) {
                // Try to zoom using window.zoomToRoute with the ROW INDEX
                if (typeof window.zoomToRoute === 'function') {
                    const success = window.zoomToRoute(routeIndex);
                    
                    if (success) {
                        // Highlight the row in the table
                        document.querySelectorAll('.route-row-highlighted').forEach(r => {
                            r.classList.remove('route-row-highlighted');
                        });
                        row.classList.add('route-row-highlighted');
                        
                        // Scroll the row into view
                        row.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        
                        // Show success notification
                        const routeName = row.querySelector('.route-name-display')?.textContent || `Route ${routeIndex + 1}`;
                        showNotification(`Zoomed to route: ${routeName}`, 'success');
                    } else {
                        showNotification('Could not zoom to route on map', 'error');
                    }
                } else {
                    showNotification('Zoom function not available', 'error');
                    console.error('‚ùå window.zoomToRoute function not found');
                }
            } else {
                showNotification('Could not determine route position', 'error');
            }
        }
    });
}

function zoomToPort(route) {
    const portCoordinates = {
        'bergen': [60.3913, 5.3221],
        'oslo': [59.9139, 10.7522],
        'stavanger': [58.9699, 5.7331],
        'trondheim': [63.4305, 10.3951],
        'alesund': [62.4722, 6.1497],
        'andalsnes': [62.5674, 7.6821],
        'kristiansand': [58.1467, 7.9956],
        'drammen': [59.7441, 10.2045],
        'sandefjord': [59.1314, 10.2167],
        'flekkefjord': [58.2975, 6.6608]
    };
    
    const city = (route.source_city || '').toLowerCase().replace('√•', 'a');
    if (city && portCoordinates[city] && window.map) {
        window.map.setView(portCoordinates[city], 12);
        showNotification(`Zoomed to ${route.source_city || 'port location'}`, 'info');
        return true;
    }
    
    return false;
}

function updateFooterStatus() {
    // Update system status based on routes
    const footerStatus = document.getElementById('footer-system-status');
    if (footerStatus) {
        if (window.dashboardData.routes.length > 0) {
            footerStatus.textContent = `${window.dashboardData.routes.length} NCA Routes Active`;
        } else {
            footerStatus.textContent = 'All Systems Operational';
        }
    }
    
    // Update API status
    const apiStatus = document.getElementById('footer-api-status');
    if (apiStatus) {
        const hasWeather = document.querySelector('#weather-temp').textContent !== '--¬∞C';
        const hasVessels = document.querySelector('#active-vessels').textContent !== '--';
        
        if (hasWeather && hasVessels) {
            apiStatus.textContent = 'All APIs Active';
            apiStatus.className = 'status-active';
        } else if (hasWeather || hasVessels) {
            apiStatus.textContent = 'Partial Service';
            apiStatus.className = 'status-partial';
        } else {
            apiStatus.textContent = 'Loading...';
            apiStatus.className = 'status-loading';
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.getElementById('dashboard-notification');
    if (!notification) return;
    
    const messageEl = notification.querySelector('#notification-message');
    if (messageEl) {
        messageEl.textContent = message;
    }
    
    // Set type styling
    const titleEl = notification.querySelector('#notification-title');
    if (titleEl) {
        const colors = {
            'info': '#17a2b8',
            'success': '#28a745',
            'warning': '#ffc107',
            'error': '#dc3545'
        };
        titleEl.style.color = colors[type] || colors.info;
        titleEl.textContent = type.charAt(0).toUpperCase() + type.slice(1);
    }
    
    // Set time
    const timeEl = notification.querySelector('#notification-time');
    if (timeEl) {
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit'
        });
    }
    
    // Show
    notification.style.display = 'block';
    
    // Auto-hide
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Debug button
document.getElementById('debug-toggle-btn')?.addEventListener('click', function() {
    console.log('=== DEBUG INFO ===');
    console.log('Routes:', window.dashboardData.routes.length);
    console.log('Map available:', !!window.map);
    console.log('Footer element:', document.querySelector('.maritime-dashboard-footer'));
});
</script>
{% endblock %}