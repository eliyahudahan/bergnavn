{% extends "base.html" %}

{% block title %}Maritime Dashboard | BergNavn{% endblock %}

{% block head %}
<!-- Dashboard-specific CSS -->
<link href="{{ url_for('static', filename='css/dashboard.css') }}" rel="stylesheet">
<!-- Font Awesome for RTZ routes icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- Leaflet MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
{% endblock %}

{% block content %}
<!-- Dashboard Header with Norwegian Theme -->
<div class="dashboard-header text-center">
    <h1 class="text-gradient">ðŸŒŠ Maritime Dashboard</h1>
    <p class="lead">Live AIS â€¢ MET Weather â€¢ RTZ Routes â€¢ Hazard Monitoring â€¢ System Health</p>
    
    <!-- Norwegian Ports Badges - All 10 active ports -->
    <div class="mt-3 ports-badges-container">
        <span class="city-badge badge-bergen" title="Bergen Port">Bergen</span>
        <span class="city-badge badge-oslo" title="Oslo Port">Oslo</span>
        <span class="city-badge badge-stavanger" title="Stavanger Port">Stavanger</span>
        <span class="city-badge badge-trondheim" title="Trondheim Port">Trondheim</span>
        <span class="city-badge badge-alesund" title="Ã…lesund Port">Ã…lesund</span>
        <span class="city-badge badge-andalsnes" title="Andalsnes Port">Andalsnes</span>
        <span class="city-badge badge-drammen" title="Drammen Port">Drammen</span>
        <span class="city-badge badge-kristiansand" title="Kristiansand Port">Kristiansand</span>
        <span class="city-badge badge-sandefjord" title="Sandefjord Port">Sandefjord</span>
        <span class="city-badge badge-flekkefjord" title="Flekkefjord Port">Flekkefjord</span>
    </div>
    <small class="text-muted mt-2 d-block">
        <i class="bi bi-info-circle me-1"></i>
        Active Norwegian ports with RTZ route coverage
    </small>
</div>

<!-- Main Dashboard Content -->
<div class="container-fluid">
    <!-- Status Bar with Local Time -->
    <div class="dashboard-controls d-flex justify-content-between align-items-center mb-4">
        <div>
            <span class="status-indicator status-live"></span>
            <small class="text-muted">Live Data: </small>
            <span class="fw-semibold text-success" id="data-status">Active</span>
            <span class="local-clock" id="local-time">--:--</span>
            
            <!-- Hazard Status Badge -->
            <span class="badge bg-warning ms-3" id="hazard-badge" style="display: none;">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <span id="hazard-count">0</span> hazards detected
            </span>
            
            <!-- System Status Badge -->
            <span class="badge bg-info ms-2" id="system-status-badge">
                <i class="bi bi-cpu me-1"></i>
                <span id="system-health-summary">System: Loading...</span>
            </span>
        </div>
        <div>
            <button class="control-btn" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
            <button class="control-btn" onclick="toggleDataView()">
                <i class="bi bi-layers"></i> Toggle View
            </button>
            <!-- RTZ Routes Toggle Button -->
            <button class="control-btn" onclick="window.rtzManager?.toggle()">
                <i class="fas fa-route"></i> RTZ Routes
            </button>
            <!-- Hazard Data Toggle Button -->
            <button class="control-btn" onclick="toggleHazards()" id="hazard-toggle">
                <i class="bi bi-exclamation-triangle"></i> Show Hazards
            </button>
            <!-- System Health Refresh Button -->
            <button class="control-btn" id="system-refresh-btn" title="Refresh System Health">
                <i class="bi bi-cpu"></i> System Health
            </button>
            <!-- Port Filter Button -->
            <button class="control-btn" onclick="showPortsFilter()">
                <i class="bi bi-filter"></i> Filter Ports
            </button>
        </div>
    </div>

    <!-- Weather + Map Row -->
    <div class="row mb-4">
        <!-- Weather Card -->
        <div class="col-lg-4 col-md-12 mb-4">
            <div class="dashboard-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-cloud-sun me-2"></i>Live Weather</h5>
                </div>
                <div class="card-body">
                    <div id="weather-box">
                        <!-- Weather content loaded by JavaScript -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Connecting to MET Norway...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer weather-footer">
                    <small>
                        <i class="bi bi-info-circle me-1"></i>
                        Source: <span id="weather-source">MET Norway API</span>
                        â€¢ Updated: <span id="weather-timestamp">--:--</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Map Card -->
        <div class="col-lg-8 col-md-12 mb-4">
            <div class="dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Norwegian Waters</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">
                            <i class="bi bi-ship me-1"></i>
                            <span id="vessel-count-number">0</span> vessels
                        </span>
                        <span class="badge bg-warning text-dark" id="map-hazard-badge" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <span id="map-hazard-count">0</span> hazards
                        </span>
                    </div>
                </div>
                <div class="card-body p-0 map-container">
                    <!-- Map Container -->
                    <div id="maritime-map"></div>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6">
                            <small class="text-muted">
                                <i class="bi bi-geo me-1"></i>
                                Center: <span id="map-center">60.39Â°N, 5.32Â°E</span>
                            </small>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <small class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                AIS Update: <span id="ais-timestamp">--:--</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats + Hazard Row -->
    <div class="row mb-4">
        <!-- Temperature -->
        <div class="col-md-3 mb-3">
            <div class="stats-card temp-stat">
                <h6><i class="bi bi-thermometer-half me-2"></i>Temperature</h6>
                <h3 id="current-temp">--Â°C</h3>
                <small class="text-muted" id="temp-location">Current â€¢ Bergen Area</small>
            </div>
        </div>
        
        <!-- Wind Speed -->
        <div class="col-md-3 mb-3">
            <div class="stats-card wind-stat">
                <h6><i class="bi bi-wind me-2"></i>Wind Speed</h6>
                <h3 id="current-wind">-- m/s</h3>
                <small class="text-muted" id="wind-location">Average â€¢ Coastal</small>
            </div>
        </div>
        
        <!-- Active Vessels -->
        <div class="col-md-3 mb-3">
            <div class="stats-card vessels-stat">
                <h6><i class="bi bi-ship me-2"></i>Active Vessels</h6>
                <h3 id="active-vessels">--</h3>
                <small class="text-muted">Norwegian Waters</small>
            </div>
        </div>
        
        <!-- Hazard Summary -->
        <div class="col-md-3 mb-3">
            <div class="stats-card hazard-stat">
                <h6><i class="bi bi-exclamation-triangle me-2"></i>Hazards</h6>
                <h3 id="hazard-summary">--</h3>
                <small class="text-muted" id="hazard-types">Loading...</small>
            </div>
        </div>
    </div>

    <!-- SYSTEM HEALTH WIDGET - ADDED HERE -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-cpu me-2"></i>System Health & Performance</h5>
                    <div>
                        <span class="badge bg-light text-dark me-2">
                            <i class="bi bi-database me-1"></i>
                            <span id="system-routes-count">--</span> routes
                        </span>
                        <span class="badge bg-light text-dark">
                            <i class="bi bi-clock me-1"></i>
                            <span id="system-uptime">--</span> uptime
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" id="system-health-widget">
                        <!-- Will be filled by system_health.js -->
                        <div class="col-12 text-center py-3">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <p class="mt-2 text-muted small">Loading system health...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted d-flex justify-content-between">
                        <span id="system-version">BergNavn v1.0.0</span>
                        <span id="system-last-update">Last update: --:--</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
    <!-- END SYSTEM HEALTH WIDGET -->

    <!-- Data Source Info & Risk Alerts -->
    <div class="row">
        <div class="col-md-8">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="bi bi-database me-3 fs-4"></i>
                    <div>
                        <small class="fw-bold">Data Sources:</small>
                        <small class="d-block">
                            â€¢ AIS: BarentsWatch API â€¢ Weather: MET Norway API â€¢ 
                            Hazards: BarentsWatch Facilities â€¢ Routes: Norwegian Coastal Database
                        </small>
                        <small class="d-block mt-1">
                            <span id="hazard-source-status" class="text-warning">
                                <i class="bi bi-circle-fill me-1"></i>Hazard data: Loading...
                            </span>
                        </small>
                        <small class="d-block mt-1">
                            <i class="bi bi-geo-alt me-1"></i>
                            Active Ports: Bergen, Oslo, Stavanger, Trondheim, Ã…lesund, Andalsnes, Drammen, Kristiansand, Sandefjord, Flekkefjord
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="alert alert-warning" id="risk-alert" style="display: none;">
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle me-2 fs-5"></i>
                    <div>
                        <small class="fw-bold" id="risk-title">Risk Alert</small>
                        <small class="d-block" id="risk-details">No high-risk vessels detected</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- External Libraries -->
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/split/maritime_map.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/maritime_weather.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/rtz_routes.js') }}"></script>
<script src="{{ url_for('static', filename='js/split/hazard_data.js') }}"></script>

<!-- NEW: System Health JavaScript -->
<script src="{{ url_for('static', filename='js/split/system_health.js') }}"></script>

<!-- Dashboard Control Functions -->
<script>
let hazardsVisible = false;
let hazardData = null;
let lastRefreshTime = null;
let riskData = null;
const activePorts = ['bergen', 'oslo', 'stavanger', 'trondheim', 'alesund', 'andalsnes', 'drammen', 'kristiansand', 'sandefjord', 'flekkefjord'];

function updateLocalTime() {
    const now = new Date();
    const options = {
        timeZone: 'Europe/Oslo',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
        weekday: 'short',
        month: 'short',
        day: 'numeric'
    };
    
    const formatter = new Intl.DateTimeFormat('en-GB', options);
    const parts = formatter.formatToParts(now);
    
    let dateString = '', timeString = '';
    
    parts.forEach(part => {
        if (part.type === 'weekday') dateString = part.value;
        if (part.type === 'month') dateString += ` ${part.value}`;
        if (part.type === 'day') dateString += ` ${part.value}`;
        if (part.type === 'hour') timeString = part.value;
        if (part.type === 'minute') timeString += `:${part.value}`;
    });
    
    const localTimeElement = document.getElementById('local-time');
    if (localTimeElement) {
        localTimeElement.textContent = `${dateString} ${timeString}`;
        localTimeElement.title = 'Norway Time (Europe/Oslo)';
    }
    
    // Update last refresh time
    if (lastRefreshTime) {
        const diff = Math.floor((now - lastRefreshTime) / 1000);
        if (diff < 60) {
            document.getElementById('data-status').textContent = `Active (${diff}s ago)`;
        } else if (diff < 3600) {
            document.getElementById('data-status').textContent = `Active (${Math.floor(diff/60)}m ago)`;
        }
    }
}

function refreshDashboard() {
    console.log('Refreshing dashboard data...');
    lastRefreshTime = new Date();
    
    // Trigger refresh of all modules
    if (typeof loadWeather === 'function') loadWeather();
    if (typeof loadAIS === 'function') loadAIS();
    if (typeof loadHazardData === 'function') loadHazardData();
    if (typeof loadRiskAssessment === 'function') loadRiskAssessment();
    
    // NEW: Refresh system health
    if (typeof window.systemHealthWidget !== 'undefined') {
        window.systemHealthWidget.refresh();
    }
    
    // Update local time
    updateLocalTime();
    document.getElementById('data-status').textContent = 'Refreshing...';
    document.getElementById('data-status').className = 'fw-semibold text-warning';
    
    // Restore status color after 3 seconds
    setTimeout(() => {
        document.getElementById('data-status').className = 'fw-semibold text-success';
    }, 3000);
}

function toggleDataView() {
    // Toggle between different map layers
    if (typeof window.toggleMapLayers === 'function') {
        window.toggleMapLayers();
    }
}

function toggleHazards() {
    hazardsVisible = !hazardsVisible;
    const button = document.getElementById('hazard-toggle');
    
    if (hazardsVisible) {
        button.innerHTML = '<i class="bi bi-eye-slash"></i> Hide Hazards';
        button.classList.add('active');
        // Load and display hazards on map
        if (typeof window.showHazardsOnMap === 'function' && hazardData) {
            window.showHazardsOnMap(hazardData);
        }
    } else {
        button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Show Hazards';
        button.classList.remove('active');
        // Hide hazards from map
        if (typeof window.hideHazardsFromMap === 'function') {
            window.hideHazardsFromMap();
        }
    }
}

function showPortsFilter() {
    // Function to show ports filter modal
    alert('Ports Filter: Click on any port badge to filter map data for that port.\n\nActive Ports: ' + activePorts.join(', '));
    
    // Add click listeners to port badges
    document.querySelectorAll('.city-badge').forEach(badge => {
        badge.addEventListener('click', function() {
            const portName = this.textContent.trim();
            console.log('Filtering for port:', portName);
            // This would call a function to filter map data
            if (typeof window.filterByPort === 'function') {
                window.filterByPort(portName.toLowerCase());
            }
        });
    });
}

function updateRiskAlert(riskData) {
    const alertElement = document.getElementById('risk-alert');
    const titleElement = document.getElementById('risk-title');
    const detailsElement = document.getElementById('risk-details');
    
    if (!riskData || !riskData.high_risk_vessels || riskData.high_risk_vessels.length === 0) {
        alertElement.style.display = 'none';
        return;
    }
    
    const highRiskCount = riskData.high_risk_vessels.length;
    const vesselNames = riskData.high_risk_vessels.map(v => v.name || `MMSI:${v.mmsi}`).slice(0, 2);
    
    titleElement.textContent = `${highRiskCount} High-Risk Vessel${highRiskCount > 1 ? 's' : ''}`;
    detailsElement.textContent = `${vesselNames.join(', ')}${highRiskCount > 2 ? ' and more...' : ''}`;
    
    alertElement.style.display = 'flex';
}

function updateSystemStatusBadge(status) {
    const badge = document.getElementById('system-status-badge');
    const summary = document.getElementById('system-health-summary');
    
    if (!badge || !summary) return;
    
    let badgeClass = 'bg-secondary';
    let statusText = 'Unknown';
    
    if (status === 'healthy') {
        badgeClass = 'bg-success';
        statusText = 'All Systems OK';
    } else if (status === 'degraded') {
        badgeClass = 'bg-warning';
        statusText = 'Degraded Performance';
    } else if (status === 'unhealthy') {
        badgeClass = 'bg-danger';
        statusText = 'System Issues';
    }
    
    badge.className = `badge ${badgeClass} ms-2`;
    summary.textContent = `System: ${statusText}`;
}

// Initialize dashboard when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('BergNavn Maritime Dashboard initialized');
    console.log('Active Ports:', activePorts);
    
    // Set initial timestamps
    updateLocalTime();
    lastRefreshTime = new Date();
    
    // Update local time every minute
    setInterval(updateLocalTime, 60000);
    
    // Auto-refresh data every 2 minutes
    setInterval(refreshDashboard, 120000);
    
    // Load initial data
    refreshDashboard();
    
    // Initialize RTZ routes when map is ready
    function initRTZWhenReady() {
        if (typeof map !== 'undefined' && typeof initRTZRoutes === 'function') {
            initRTZRoutes(map);
        } else {
            setTimeout(initRTZWhenReady, 500);
        }
    }
    
    initRTZWhenReady();
    
    // Add click handlers to port badges
    document.querySelectorAll('.city-badge').forEach(badge => {
        badge.style.cursor = 'pointer';
        badge.title = 'Click to filter for ' + badge.textContent + ' port';
    });
    
    // Initialize System Health button
    const systemBtn = document.getElementById('system-refresh-btn');
    if (systemBtn) {
        systemBtn.onclick = function() {
            if (typeof window.systemHealthWidget !== 'undefined') {
                window.systemHealthWidget.refresh();
                // Visual feedback
                const originalHTML = systemBtn.innerHTML;
                systemBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';
                systemBtn.disabled = true;
                
                setTimeout(() => {
                    systemBtn.innerHTML = originalHTML;
                    systemBtn.disabled = false;
                }, 1000);
            }
        };
    }
    
    // Listen for system health updates to update badge
    document.addEventListener('systemHealthUpdate', function(event) {
        if (event.detail && event.detail.status) {
            updateSystemStatusBadge(event.detail.status);
        }
    });
});
</script>
{% endblock %}