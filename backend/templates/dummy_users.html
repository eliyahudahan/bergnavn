{% extends "base.html" %}

{% block title %}{{ translate('title', lang, 'dummy_users') }}{% endblock %}

{% block content %}
<!-- Page heading -->
<h2 class="mb-3">{{ translate('title', lang, 'dummy_users') }}</h2>
<p class="text-muted">
  {{ translate('manage_info', lang, 'dummy_users') }}
  "{{ translate('create_new_user', lang, 'dummy_users') }}" {{ translate('to_add_dummy_user', lang, 'dummy_users') }}
</p>

<!-- Alerts -->
{% if error %}
  <div class="alert alert-danger">{{ error }}</div>
{% endif %}
{% if message %}
  <div class="alert alert-success">{{ message }}</div>
{% endif %}

<!-- Filter buttons for active/inactive/all users -->
<div class="mb-3">
  <a href="{{ url_for('dummy_user_bp.dummy_user_ui', filter='active', lang=lang) }}" 
     class="btn btn-outline-primary {% if filter_status == 'active' %}active{% endif %}">
    {{ translate('active', lang, 'global') }} {{ translate('users', lang, 'global') }}
  </a>
  <a href="{{ url_for('dummy_user_bp.dummy_user_ui', filter='inactive', lang=lang) }}" 
     class="btn btn-outline-secondary {% if filter_status == 'inactive' %}active{% endif %}">
    {{ translate('inactive', lang, 'global') }} {{ translate('users', lang, 'global') }}
  </a>
  <a href="{{ url_for('dummy_user_bp.dummy_user_ui', filter='all', lang=lang) }}" 
     class="btn btn-outline-dark {% if filter_status == 'all' %}active{% endif %}">
    {{ translate('all', lang, 'global') }} {{ translate('users', lang, 'global') }}
  </a>
</div>

<!-- Users table -->
<div class="table-responsive">
  <table class="table table-striped table-hover" id="dummy-users-table">
    <thead class="table-primary">
      <tr>
        <th>{{ translate('status', lang, 'global') }}</th>
        <th>{{ translate('username', lang, 'dummy_users') }}</th>
        <th>{{ translate('email', lang, 'dummy_users') }}</th>
        <th>{{ translate('scenario', lang, 'dummy_users') }}</th>
        <th>{{ translate('actions', lang, 'global') }}</th>
        <th>{{ translate('activate', lang, 'global') }} / {{ translate('deactivate', lang, 'global') }}</th>
      </tr>
    </thead>
    <tbody>
      {% for user in users %}
      <tr data-user-id="{{ user.id }}">
        <!-- Status badge -->
        <td class="status-cell">
          {% if user.active %}
            <span class="badge bg-success">{{ translate('active', lang, 'global') }}</span>
          {% else %}
            <span class="badge bg-secondary">{{ translate('inactive', lang, 'global') }}</span>
          {% endif %}
        </td>
        <td>{{ user.username }}</td>
        <td>{{ user.email }}</td>
        <td>{{ user.scenario }}</td>
        <!-- Edit action -->
        <td>
          <a href="{{ url_for('dummy_user_bp.edit_user_form', user_id=user.id, lang=lang) }}" 
             class="btn btn-sm btn-primary">
            <i class="bi bi-pencil"></i> {{ translate('edit', lang, 'global') }}
          </a>
        </td>
        <!-- Toggle active/inactive -->
        <td>
          <button class="btn btn-sm toggle-active-btn {{ 'btn-danger' if user.active else 'btn-success' }}">
            {{ translate('deactivate', lang, 'global') if user.active else translate('activate', lang, 'global') }}
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Create new user button -->
<div class="mt-3">
  <a href="{{ url_for('dummy_user_bp.show_create_user_form', lang=lang) }}" class="btn btn-success">
    <i class="bi bi-plus-lg"></i> {{ translate('create_new_user', lang, 'dummy_users') }}
  </a>
</div>

<!-- JavaScript to handle active/inactive toggle -->
<script>
// Translation constants for JS
const TRANSLATIONS = {
    activate: "{{ translate('activate', lang, 'global') }}",
    deactivate: "{{ translate('deactivate', lang, 'global') }}",
    active: "{{ translate('active', lang, 'global') }}",
    inactive: "{{ translate('inactive', lang, 'global') }}"
};

document.addEventListener('DOMContentLoaded', function () {
  const table = document.getElementById('dummy-users-table');
  table.querySelectorAll('.toggle-active-btn').forEach(button => {
    button.addEventListener('click', function () {
      const row = this.closest('tr');
      const userId = row.getAttribute('data-user-id');
      const currentlyActive = row.querySelector('.status-cell .badge').classList.contains('bg-success');
      const newActiveState = !currentlyActive;

      fetch(`/dummy-users/toggle/${userId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ active: newActiveState })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const statusCell = row.querySelector('.status-cell');
          const btn = row.querySelector('.toggle-active-btn');

          if (data.active) {
            statusCell.innerHTML = `<span class="badge bg-success">${TRANSLATIONS.active}</span>`;
            btn.textContent = TRANSLATIONS.deactivate;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-danger');
          } else {
            statusCell.innerHTML = `<span class="badge bg-secondary">${TRANSLATIONS.inactive}</span>`;
            btn.textContent = TRANSLATIONS.activate;
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-success');
          }
        }
      })
      .catch(error => console.error('Request failed:', error));
    });
  });
});
</script>
{% endblock %}
