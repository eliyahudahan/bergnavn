# ---------------------------------------
# Maritime API Blueprint â€“ AIS + MET
# ---------------------------------------
from flask import Blueprint, jsonify
import aiohttp
import asyncio

# API blueprint
maritime_bp = Blueprint("maritime", __name__, url_prefix="/api/maritime")

# ---------------------------
# AIS (Kystverket live TCP)
# ---------------------------
AIS_TCP_HOST = "153.44.253.27"
AIS_TCP_PORT = 5631

async def read_ais_packets():
    try:
        reader, writer = await asyncio.open_connection(AIS_TCP_HOST, AIS_TCP_PORT)
        packets = []
        for _ in range(5):
            line = await reader.readline()
            if not line:
                break
            packets.append(line.decode("utf-8", errors="ignore").strip())
        writer.close()
        await writer.wait_closed()
        return packets
    except Exception as e:
        return {"error": str(e)}

@maritime_bp.get("/ais")
async def get_ais():
    packets = await read_ais_packets()
    return jsonify({
        "success": True,
        "packets": packets
    })

# ---------------------------
# MET Norway Weather API
# ---------------------------
MET_URL = "https://api.met.no/weatherapi/locationforecast/2.0/compact"
TRACKED_COORDS = [
    {"lat": 60.39, "lon": 5.32},  # Bergen
    {"lat": 59.91, "lon": 10.75}, # Oslo
    {"lat": 58.97, "lon": 5.73},  # Stavanger
]

headers = {
    "User-Agent": "BergNavn-Maritime-Student-Project"
}

async def fetch_weather_point(session, lat, lon):
    async with session.get(f"{MET_URL}?lat={lat}&lon={lon}", headers=headers) as r:
        data = await r.json()
        details = data["properties"]["timeseries"][0]["data"]["instant"]["details"]
        return {
            "lat": lat,
            "lon": lon,
            "weather": {
                "wind_speed": details.get("wind_speed", 0),
                "wind_direction": details.get("wind_from_direction", 0),
            }
        }

@maritime_bp.get("/weather")
async def get_weather():
    async with aiohttp.ClientSession() as session:
        tasks = [
            fetch_weather_point(session, c["lat"], c["lon"])
            for c in TRACKED_COORDS
        ]
        points = await asyncio.gather(*tasks)

    return jsonify({
        "success": True,
        "points": points
    })
