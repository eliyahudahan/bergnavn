version: '3.8'

services:
  migration-runner:
    build: .
    command: >
      sh -c "
        echo 'ğŸ” Running pre-migration checks...' &&
        python check_migration_health.py &&
        echo 'ğŸ’¾ Creating backup...' &&
        pg_dump $$DATABASE_URL > /backups/backup_$(date +%Y%m%d_%H%M%S).sql &&
        echo 'ğŸ”§ Running migration...' &&
        flask db upgrade &&
        echo 'ğŸ” Running post-migration checks...' &&
        python check_migration_health.py &&
        echo 'ğŸ‰ Migration completed successfully!'
      "
    environment:
      - DATABASE_URL=postgresql://framg:copenhagen2024@db:5432/framg
      - FLASK_APP=app.py
    volumes:
      - ./backups:/backups
    depends_on:
      - db
  
  db:
    image: postgres:14
    environment:
      - POSTGRES_USER=framg
      - POSTGRES_PASSWORD=copenhagen2024
      - POSTGRES_DB=framg
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups

volumes:
  postgres_data:
